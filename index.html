<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Flame & Feast POS</title>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Outfit', 'sans-serif'],
                    },
                    colors: {
                        gray: {
                            850: '#1f2937',
                            900: '#111827',
                            950: '#0B0F19',
                        },
                        accent: {
                            500: '#F97316',
                            600: '#EA580C',
                        }
                    }
                }
            }
        }
    </script>

    <!-- Vector Icons (Lucide) -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Custom Styles -->
    <style>
        /* Glassmorphism Utilities */
        .glass {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .glass-panel {
            background: rgba(17, 24, 39, 0.6);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /* Base resets */
        body {
            -webkit-tap-highlight-color: transparent;
        }

        /* Print Styles for 58mm Thermal Printer */
        @media print {
            body * {
                visibility: hidden;
            }

            #receipt-print-area,
            #receipt-print-area * {
                visibility: visible;
            }

            #receipt-print-area {
                display: block !important;
                position: absolute;
                left: 0;
                top: 0;
                width: 58mm;
                padding: 0;
                margin: 0;
                color: black;
                background: white;
                font-family: 'Courier New', Courier, monospace;
                font-size: 12px;
                z-index: 9999;
            }

            html,
            body {
                height: auto;
                overflow: visible;
                background: white;
            }
        }
    </style>

    <!-- Error Handler -->
    <script>
        window.onerror = function (msg, url, line, col, error) {
            alert("Error: " + msg + "\nLine: " + line + "\nCol: " + col);
            document.getElementById('app').innerHTML = '<div class="text-red-500 p-10 font-mono">Error: ' + msg + '<br>Line: ' + line + '</div>';
        };
    </script>
</head>

<body class="bg-gray-950 text-white font-sans h-screen w-screen overflow-hidden select-none">

    <div id="app" class="h-full w-full flex">
        <div class="m-auto text-gray-500 animate-pulse">Cargando Sistema POS...</div>
    </div>

    <!-- Modals & Print (Always persistent) -->
    <div id="modal-container"></div>
    <div id="receipt-print-area" class="hidden"></div>

    <!-- Application Logic (Inlined for reliability) -->

    <!-- 1. STORE -->
    <script>
        const STORAGE_KEY = 'pos_data_v1';

        const INITIAL_DATA = {
            users: [
                { id: 1, name: 'Cajero Principal', pin: '1234' },
                { id: 2, name: 'Gerente', pin: '0000' },
                { id: 3, name: 'Master', pin: '9999' }
            ],
            categories: [
                { id: 'burgers', name: 'Hamburguesas' },
                { id: 'sides', name: 'Acompañantes' },
                { id: 'drinks', name: 'Bebidas' }
            ],
            inventory: [
                { id: 'inv_1', name: 'Pan de Hamburguesa', unit: 'unidad', quantity: 100, alert: 20 },
                { id: 'inv_2', name: 'Carne de Res', unit: 'unidad', quantity: 100, alert: 20 },
                { id: 'inv_3', name: 'Queso Cheddar', unit: 'unidad', quantity: 100, alert: 20 },
                { id: 'inv_4', name: 'Papas Congeladas', unit: 'kg', quantity: 50.0, alert: 10.0 },
                { id: 'inv_5', name: 'Cebolla Morada', unit: 'kg', quantity: 10.0, alert: 2.0 },
                { id: 'inv_6', name: 'Salsa Especial', unit: 'L', quantity: 5.0, alert: 1.0 },
                { id: 'inv_7', name: 'Refresco Cola', unit: 'unidad', quantity: 200, alert: 24 }
            ],
            inventory_movements: [],
            bcvRate: { rate: 0, lastUpdated: null }, // BCV Rate State
            products: [
                {
                    id: 'p_1',
                    name: 'Classic Burger',
                    price: 150.00,
                    category: 'burgers',
                    image: 'https://images.unsplash.com/photo-1568901346375-23c9450c58cd?auto=format&fit=crop&w=500&q=60',
                    recipe: [
                        { id: 'inv_1', qty: 1 },
                        { id: 'inv_2', qty: 1 },
                        { id: 'inv_3', qty: 1 },
                        { id: 'inv_5', qty: 0.05 },
                        { id: 'inv_6', qty: 0.02 }
                    ]
                },
                {
                    id: 'p_2',
                    name: 'Papas Fritas',
                    price: 80.00,
                    category: 'sides',
                    image: 'https://images.unsplash.com/photo-1630384060421-a4323ceca0ad?auto=format&fit=crop&w=500&q=60',
                    recipe: [
                        { id: 'inv_4', qty: 0.25 }
                    ]
                },
                {
                    id: 'p_3',
                    name: 'Coca Cola',
                    price: 40.00,
                    category: 'drinks',
                    image: 'https://images.unsplash.com/photo-1622483767028-3f66f32aef97?auto=format&fit=crop&w=500&q=60',
                    recipe: [
                        { id: 'inv_7', qty: 1 }
                    ]
                }
            ],
            sales: [],
            lastTicketNumber: 0,
            settings: {
                storeName: 'Flame & Feast Fast Food'
            }
        };

        class Store {
            constructor() {
                this.state = this.load();
                this.cart = [];
                this.currentUser = null;
                this.listeners = [];
            }

            load() {
                const stored = localStorage.getItem(STORAGE_KEY);
                let state;
                try {
                    state = stored ? JSON.parse(stored) : null;
                } catch (e) {
                    state = null;
                }

                if (!state) {
                    return JSON.parse(JSON.stringify(INITIAL_DATA));
                }

                // Merge top-level objects to ensure new fields (like lastTicketNumber) exist
                state = { ...INITIAL_DATA, ...state };

                // Merge users by ID to ensure Master user exists even if localStorage has old data
                if (INITIAL_DATA.users && state.users) {
                    INITIAL_DATA.users.forEach(initialUser => {
                        const exists = state.users.find(u => u.id === initialUser.id);
                        if (!exists) {
                            state.users.push(JSON.parse(JSON.stringify(initialUser)));
                        }
                    });
                }

                return state;
            }

            save() {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(this.state));
                this.notify();
            }

            reset() {
                this.state = JSON.parse(JSON.stringify(INITIAL_DATA));
                this.save();
            }

            login(pin) {
                const user = this.state.users.find(u => u.pin === pin);
                if (user) {
                    this.currentUser = user;
                    this.notify();
                    return true;
                }
                return false;
            }

            logout() {
                this.currentUser = null;
                this.cart = [];
                this.notify();
            }

            addToCart(product, notes = '') {
                const maxStock = this.calculateMaxStock(product);

                // Calculate current total quantity of this product in cart
                const currentQtyInCart = this.cart.reduce((sum, item) =>
                    item.product.id === product.id ? sum + item.qty : sum, 0);

                if (currentQtyInCart + 1 > maxStock) {
                    alert('¡No hay suficiente stock para agregar más de este producto!');
                    return false;
                }

                // Check if exact item (same product + same notes) exists
                const existingItem = this.cart.find(item =>
                    item.product.id === product.id && item.notes === notes
                );

                if (existingItem) {
                    existingItem.qty++;
                } else {
                    this.cart.push({
                        id: Date.now() + Math.random(),
                        product: product,
                        notes: notes,
                        qty: 1
                    });
                }

                this.notify();
                return true;
            }

            removeFromCart(cartItemId) {
                this.cart = this.cart.filter(item => item.id !== cartItemId);
                this.notify();
            }

            decreaseCartItem(cartItemId) {
                const item = this.cart.find(i => i.id === cartItemId);
                if (item) {
                    if (item.qty > 1) {
                        item.qty--;
                    } else {
                        // Remove if qty is 1
                        this.cart = this.cart.filter(i => i.id !== cartItemId);
                    }
                    this.notify();
                }
            }

            clearCart() {
                this.cart = [];
                this.notify();
            }

            getCartTotal() {
                return this.cart.reduce((total, item) => total + (item.product.price * item.qty), 0);
            }

            calculateMaxStock(product) {
                let min = Infinity;
                if (!product.recipe || product.recipe.length === 0) return 9999;

                product.recipe.forEach(ing => {
                    const inventoryItem = this.state.inventory.find(inv => inv.id === ing.id);
                    if (!inventoryItem) return;

                    const possible = Math.floor(inventoryItem.quantity / ing.qty);
                    if (possible < min) min = possible;
                });
                return min;
            }

            checkout() {
                if (this.cart.length === 0) return false;

                this.state.lastTicketNumber = (this.state.lastTicketNumber || 0) + 1;
                const sale = {
                    id: Date.now(),
                    ticketNumber: this.state.lastTicketNumber,
                    date: new Date().toISOString(),
                    employee: this.currentUser.name,
                    total: this.getCartTotal(),
                    items: JSON.parse(JSON.stringify(this.cart)), // Deep copy with qty
                };

                this.cart.forEach(item => {
                    if (item.product.recipe) {
                        item.product.recipe.forEach(ing => {
                            const inventoryItem = this.state.inventory.find(inv => inv.id === ing.id);
                            if (inventoryItem) {
                                // Deduct: ingredient qty * item qty
                                const totalDeduction = ing.qty * item.qty;
                                inventoryItem.quantity = Number((inventoryItem.quantity - totalDeduction).toFixed(3));
                            }
                        });
                    }
                });

                this.state.sales.push(sale);
                this.save();
                this.clearCart();
                return sale;
            }

            updateInventory(id, quantity) {
                // Deprecated in favor of adjustInventory for manual edits
                const item = this.state.inventory.find(i => i.id === id);
                if (item) {
                    item.quantity = Number(quantity);
                    this.save();
                }
            }

            restockInventory(id, qtyToAdd, user) {
                const item = this.state.inventory.find(i => i.id === id);
                if (item) {
                    const oldQuantity = item.quantity;
                    const newQuantity = Number(oldQuantity) + Number(qtyToAdd);

                    if (!this.state.inventory_movements) this.state.inventory_movements = [];

                    this.state.inventory_movements.push({
                        id: Date.now(),
                        itemId: id,
                        itemName: item.name,
                        oldQty: oldQuantity,
                        newQty: newQuantity,
                        diff: qtyToAdd,
                        note: "Reposición de Inventario",
                        user: user.name,
                        date: new Date().toISOString()
                    });

                    item.quantity = newQuantity;
                    this.save();
                    return true;
                }
                return false;
            }

            async fetchBCVRate() {
                try {
                    console.log("Fetching BCV Rate directly from bcv.org.ve...");

                    // Strategy: Direct Scrape via AllOrigins CORS Proxy
                    const targetUrl = 'https://www.bcv.org.ve/';
                    const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(targetUrl)}&timestamp=${Date.now()}`;

                    const response = await fetch(proxyUrl);
                    if (!response.ok) throw new Error('Proxy error');

                    const data = await response.json();
                    const html = data.contents;

                    // Parsing BCV HTML for USD rate
                    // Typical structure: <div id="dolar"> ... <strong> 36,54 </strong> ... </div>
                    const usdMatch = html.match(/id="dolar"[^>]*>[\s\S]*?<strong>\s*([\d,.]+)\s*<\/strong>/i);

                    if (usdMatch && usdMatch[1]) {
                        const rawRate = usdMatch[1].replace(',', '.'); // Handle comma as decimal
                        const rate = parseFloat(rawRate);

                        if (!isNaN(rate) && rate > 0) {
                            console.log("Direct BCV Rate Parsed:", rate);
                            return this.updateRate(rate);
                        }
                    }

                    throw new Error('Could not parse BCV HTML');

                } catch (error) {
                    console.warn("Direct BCV Fetch failed, trying fallback API...", error);
                    try {
                        // Fallback fallback: ve.dolarapi.com
                        const response = await fetch('https://ve.dolarapi.com/v1/dolares/oficial');
                        if (response.ok) {
                            const data = await response.json();
                            if (data && data.promedio) {
                                return this.updateRate(parseFloat(data.promedio));
                            }
                        }
                    } catch (err) {
                        console.error("All BCV fetches failed:", err);
                        if (!this.state.bcvRate || this.state.bcvRate.rate <= 0) {
                            this.state.bcvRate = { rate: -1, lastUpdated: null };
                            this.notify();
                        }
                    }
                }
                return null;
            }

            updateRate(rate, isManual = false) {
                console.log("BCV Rate Updated:", rate);
                this.state.bcvRate = {
                    rate: Number(rate),
                    lastUpdated: new Date().toISOString(),
                    isManual: isManual
                };
                this.save();
                this.notify();
                return rate;
            }

            addInventoryItem(item) {
                this.state.inventory.push(item);
                this.save();
            }

            deleteInventoryItem(id) {
                // Check usage in recipes
                const isUsed = this.state.products.some(p => p.recipe && p.recipe.some(r => r.id === id));
                if (isUsed) {
                    alert('No se puede eliminar este ingrediente porque está siendo usado en la receta de un producto.');
                    return false;
                }

                this.state.inventory = this.state.inventory.filter(i => i.id !== id);
                this.save();
                return true;
            }

            addProduct(product) {
                this.state.products.push(product);
                this.save();
            }

            updateProduct(product) {
                const index = this.state.products.findIndex(p => p.id === product.id);
                if (index !== -1) {
                    this.state.products[index] = product;
                    this.save();
                }
            }

            deleteProduct(id) {
                this.state.products = this.state.products.filter(p => p.id !== id);
                this.save();
            }

            addCategory(category) {
                this.state.categories.push(category);
                this.save();
            }

            deleteCategory(id) {
                // Check if used
                const isUsed = this.state.products.some(p => p.category === id);
                if (isUsed) {
                    alert('No se puede eliminar esta categoría porque hay productos que la usan.');
                    return false;
                }
                this.state.categories = this.state.categories.filter(c => c.id !== id);
                this.save();
                return true;
            }

            closeSession() {
                this.state.sales = [];
                this.state.lastTicketNumber = 0;
                this.save();
            }

            updateUserPin(userId, newPin) {
                const user = this.state.users.find(u => u.id === userId);
                if (user) {
                    user.pin = newPin;
                    this.save();
                    return true;
                }
                return false;
            }

            subscribe(listener) {
                this.listeners.push(listener);
                listener(this);
            }

            notify() {
                this.listeners.forEach(listener => listener(this));
            }
        }

        window.store = new Store();
    </script>

    <!-- 2. VIEWS -->
    <script>
        window.views = {
            renderLogin() {
                const store = window.store;
                return `
                    <div class="flex flex-col items-center justify-center w-full h-full bg-gray-950 pattern-grid">
                        <div class="glass-panel p-8 rounded-2xl flex flex-col items-center w-96 max-w-full m-4">
                            <div class="w-16 h-16 bg-orange-600 rounded-full flex items-center justify-center mb-6 shadow-lg shadow-orange-900/50">
                                <i data-lucide="flame" class="w-8 h-8 text-white"></i>
                            </div>
                            <h1 class="text-3xl font-bold mb-2">Flame & Feast</h1>
                            <p class="text-gray-400 mb-8">Sistema de Punto de Venta</p>
                            
                            <div class="w-full space-y-4">
                                <h3 class="text-sm font-semibold text-gray-500 uppercase tracking-widest mb-2">Seleccionar Usuario</h3>
                                <div class="grid gap-3">
                                    ${store.state.users.map(u => `
                                        <button onclick="window.posApp.requestPin('${u.pin}', '${u.name}')" 
                                            class="user-btn bg-gray-800 hover:bg-gray-700 p-4 rounded-xl flex items-center gap-4 transition-all w-full text-left group">
                                            <div class="w-10 h-10 rounded-full bg-gray-700 group-hover:bg-orange-600 text-white flex items-center justify-center font-bold transition-colors">
                                                ${u.name.charAt(0)}
                                            </div>
                                            <span class="font-medium text-lg">${u.name}</span>
                                        </button>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            },

            renderPOS() {
                const store = window.store;
                const products = store.state.products;
                const cart = store.cart;

                return `
                    <!-- Cart Panel -->
                    <section class="min-w-[350px] w-1/3 max-w-[450px] h-full p-4 flex flex-col z-10">
                        <div class="glass-panel rounded-3xl h-full flex flex-col p-5 relative overflow-hidden">
                            <div class="flex items-center justify-between mb-6">
                                <div class="flex items-center gap-3">
                                     <div class="w-10 h-10 rounded-full bg-orange-600/20 flex items-center justify-center text-orange-500">
                                        <i data-lucide="shopping-cart" class="w-5 h-5"></i>
                                     </div>
                                      <div>
                                        <h2 class="text-lg font-bold leading-none">Orden Actual</h2>
                                        <span class="text-xs text-gray-400">Ticket #${(store.state.lastTicketNumber || 0) + 1}</span>
                                      </div>
                                </div>
                                <button onclick="window.posApp.clearCart()" class="p-2 rounded-lg bg-gray-800 hover:bg-red-500/20 hover:text-red-500 text-gray-400 transition-colors" title="Limpiar Carrito">
                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                </button>
                            </div>

                            <div class="flex-1 overflow-y-auto space-y-3 pr-1 custom-scrollbar">
                                ${cart.length === 0 ? `
                                    <div class="h-full flex flex-col items-center justify-center text-gray-500 opacity-50 space-y-4">
                                        <i data-lucide="shopping-bag" class="w-20 h-20 stroke-1"></i>
                                        <p class="text-sm">Selecciona productos del menú</p>
                                    </div>
                                ` : cart.map(item => `
                                    <div class="relative flex items-start gap-3 p-3 rounded-xl bg-gray-800/40 border border-gray-700/50 hover:bg-gray-800/60 transition-colors group animate-fade-in-right">
                                        <div class="relative">
                                            <img src="${item.product.image}" class="w-16 h-16 rounded-lg object-cover bg-gray-800" />
                                            <div class="absolute -top-2 -left-2 bg-orange-600 text-white text-xs font-bold w-6 h-6 rounded-full flex items-center justify-center shadow-lg border border-gray-900">
                                                ${item.qty}
                                            </div>
                                        </div>
                                        <div class="flex-1 min-w-0 py-1">
                                            <div class="flex justify-between items-start">
                                                <h4 class="font-bold text-gray-200 truncate pr-2">${item.product.name}</h4>
                                                <span class="font-bold text-orange-400">$${(item.product.price * item.qty).toFixed(2)}</span>
                                            </div>
                                            ${item.notes ? `
                                                <div class="mt-1 flex items-start gap-1">
                                                    <i data-lucide="file-edit" class="w-3 h-3 text-gray-500 mt-0.5"></i>
                                                    <p class="text-xs text-gray-400 italic leading-snug">"${item.notes}"</p>
                                                </div>
                                            ` : ''}
                                            <div class="absolute -top-2 -right-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                                <button onclick="window.posApp.removeFromCart(${item.id})" class="bg-red-500 text-white rounded-full p-1 shadow-lg hover:scale-110 transition-transform" title="Quitar 1 unidad">
                                                    <i data-lucide="minus" class="w-3 h-3"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>

                            <div class="mt-4 pt-4 border-t border-white/5 bg-gray-900/30 -mx-5 px-5 pb-0">
                               <div class="flex justify-between items-end mb-4">
                                    <span class="text-gray-400 text-sm font-medium uppercase tracking-wider">Total a Pagar</span>
                                    <span class="text-4xl font-bold text-white tracking-tight">$${store.getCartTotal().toFixed(2)}</span>
                               </div>
                               
                               <button onclick="window.posApp.checkout()" 
                                    class="w-full py-4 rounded-xl bg-gradient-to-r from-orange-600 to-orange-500 hover:from-orange-500 hover:to-orange-400 text-white font-bold text-lg shadow-lg shadow-orange-900/50 transition-all transform active:scale-95 flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
                                    ${cart.length === 0 ? 'disabled' : ''}>
                                    <i data-lucide="credit-card" class="w-5 h-5"></i>
                                    <span>COBRAR E IMPRIMIR</span>
                               </button>
                            </div>
                        </div>
                    </section>

                    <!-- Product Grid -->
                    <section class="flex-1 h-full p-4 pl-0 overflow-y-auto custom-scrollbar">
                        <div class="sticky top-0 z-20 bg-gray-950/90 backdrop-blur-sm pb-4 pt-2 mb-4 border-b border-gray-800 flex items-center justify-between">
                            <div>
                                 <h2 class="text-2xl font-bold text-white">Menú Principal</h2>
                                 <p class="text-gray-400 text-sm">Mostrando todos los productos</p>
                            </div>
                            <div class="flex gap-2 overflow-x-auto">
                                <div class="bg-gray-800 rounded-lg p-1 flex">
                                    <button onclick="window.posApp.filterCategory('all')" 
                                        class="px-4 py-1.5 rounded-md text-sm font-medium transition-colors ${window.posApp.activeCategory === 'all' ? 'bg-orange-600 text-white shadow' : 'text-gray-400 hover:text-white'}">
                                        Todos
                                    </button>
                                    ${store.state.categories ? store.state.categories.map(c => `
                                        <button onclick="window.posApp.filterCategory('${c.id}')" 
                                            class="px-4 py-1.5 rounded-md text-sm font-medium transition-colors whitespace-nowrap ${window.posApp.activeCategory === c.id ? 'bg-orange-600 text-white shadow' : 'text-gray-400 hover:text-white'}">
                                            ${c.name}
                                        </button>
                                    `).join('') : ''}
                                </div>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 pb-20">
                            ${products
                        .filter(p => window.posApp.activeCategory === 'all' || p.category === window.posApp.activeCategory)
                        .map(p => {
                            const maxStock = store.calculateMaxStock(p);
                            const isOutOfStock = maxStock <= 0;
                            const isLowStock = maxStock < 5 && maxStock > 0;

                            return `
                                <div onclick="${!isOutOfStock ? `window.posApp.openProductModal('${p.id}')` : ''}" 
                                     class="card bg-gray-900/60 border border-gray-800 hover:border-orange-500/50 rounded-2xl p-3 flex flex-col gap-3 transition-all group relative overflow-hidden cursor-pointer ${isOutOfStock ? 'opacity-50 grayscale pointer-events-none' : ''}">
                                    
                                    <div class="aspect-[4/3] rounded-xl overflow-hidden relative shadow-inner">
                                        <img src="${p.image}" class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500" loading="lazy">
                                        ${isOutOfStock ? `
                                            <div class="absolute inset-0 bg-black/70 flex items-center justify-center backdrop-blur-sm">
                                                <span class="px-3 py-1 bg-red-600 text-white text-xs font-bold rounded-full shadow-lg">AGOTADO</span>
                                            </div>
                                        ` : ''}
                                        ${isLowStock ? `
                                            <div class="absolute top-2 right-2">
                                                <span class="px-2 py-0.5 bg-orange-500 text-white text-[10px] font-bold rounded-full shadow-lg animate-pulse">POCAS UNIDADES</span>
                                            </div>
                                        ` : ''}
                                    </div>
                                    
                                    <div class="flex-1 flex flex-col">
                                        <h3 class="font-bold text-gray-100 text-lg leading-tight mb-1 group-hover:text-orange-400 transition-colors">${p.name}</h3>
                                        <p class="text-sm text-gray-500 line-clamp-2 mb-3">Toca para personalizar</p>
                                        
                                        <div class="mt-auto flex justify-between items-center">
                                            <span class="text-xl font-bold text-white">$${p.price}</span>
                                            <div class="w-8 h-8 rounded-full bg-gray-800 group-hover:bg-orange-600 flex items-center justify-center text-white transition-colors shadow">
                                                <i data-lucide="plus" class="w-5 h-5"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `}).join('')}
                        </div>
                    </section>
                `;
            },

            renderAdmin() {
                try {
                    const store = window.store;
                    const inventory = store.state.inventory;
                    const products = store.state.products;
                    const sales = store.state.sales;
                    const activeTab = window.posApp.adminTab || 'dashboard';
                    const isManager = store.currentUser && (store.currentUser.id === 2 || store.currentUser.id === 3);
                    const isMaster = store.currentUser && store.currentUser.id === 3;
                    // alert('Debug: renderAdmin called. isManager: ' + isManager);

                    const renderTabs = () => `
                    <div class="flex gap-4 mb-8 border-b border-gray-800 pb-1 overflow-x-auto">
                        <button onclick="window.posApp.setAdminTab('dashboard')" class="${activeTab === 'dashboard' ? 'text-orange-500 border-b-2 border-orange-500' : 'text-gray-400 hover:text-white'} pb-3 px-2 font-medium transition-colors whitespace-nowrap">Dashboard</button>
                        <button onclick="window.posApp.setAdminTab('inventory')" class="${activeTab === 'inventory' ? 'text-orange-500 border-b-2 border-orange-500' : 'text-gray-400 hover:text-white'} pb-3 px-2 font-medium transition-colors whitespace-nowrap">Inventario</button>
                        ${isManager ? `
                            <button onclick="window.posApp.setAdminTab('products')" class="${activeTab === 'products' ? 'text-orange-500 border-b-2 border-orange-500' : 'text-gray-400 hover:text-white'} pb-3 px-2 font-medium transition-colors whitespace-nowrap">Productos</button>
                            <button onclick="window.posApp.setAdminTab('categories')" class="${activeTab === 'categories' ? 'text-orange-500 border-b-2 border-orange-500' : 'text-gray-400 hover:text-white'} pb-3 px-2 font-medium transition-colors whitespace-nowrap">Categorías</button>
                        ` : ''}
                        ${isMaster ? `
                            <button onclick="window.posApp.setAdminTab('users')" class="${activeTab === 'users' ? 'text-orange-500 border-b-2 border-orange-500' : 'text-gray-400 hover:text-white'} pb-3 px-2 font-medium transition-colors whitespace-nowrap">Usuarios</button>
                        ` : ''}
                    </div>
                `;

                    let content = '';

                    if (activeTab === 'dashboard') {
                        const totalSales = sales.reduce((sum, s) => sum + s.total, 0);
                        content = `
                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-8">
                             <!-- Stats Cards Grid -->
                             <div class="grid grid-cols-1 md:grid-cols-3 gap-4 flex-1 w-full">
                                <div class="glass-panel p-4 rounded-2xl flex items-center gap-3">
                                    <div class="p-2 bg-green-500/20 text-green-500 rounded-xl"><i data-lucide="dollar-sign" class="w-6 h-6"></i></div>
                                    <div><p class="text-gray-400 text-xs font-medium">Ventas Totales</p><h3 class="text-xl font-bold text-white">$${totalSales.toFixed(2)}</h3></div>
                                </div>
                                <div class="glass-panel p-4 rounded-2xl flex items-center gap-3">
                                    <div class="p-2 bg-blue-500/20 text-blue-500 rounded-xl"><i data-lucide="shopping-bag" class="w-6 h-6"></i></div>
                                    <div><p class="text-gray-400 text-xs font-medium">Transacciones</p><h3 class="text-xl font-bold text-white">${sales.length}</h3></div>
                                </div>
                                <div class="glass-panel p-4 rounded-2xl flex items-center gap-3">
                                    <div class="p-2 bg-orange-500/20 text-orange-500 rounded-xl"><i data-lucide="alert-triangle" class="w-6 h-6"></i></div>
                                    <div><p class="text-gray-400 text-xs font-medium">Alertas Stock</p><h3 class="text-xl font-bold text-white">${inventory.filter(i => i.quantity < i.alert).length}</h3></div>
                                </div>
                            </div>
                            
                            <!-- Session Actions -->
                            <div class="flex gap-2">
                                <button onclick="window.posApp.handlePrintSessionReport()" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg font-bold flex items-center gap-2 shadow-lg shadow-blue-900/20 transition-all">
                                    <i data-lucide="printer" class="w-4 h-4"></i> IMPRIMIR
                                </button>
                                <button onclick="window.posApp.handleCloseSession()" class="bg-red-600 hover:bg-red-500 text-white px-4 py-2 rounded-lg font-bold flex items-center gap-2 shadow-lg shadow-red-900/20 transition-all">
                                    <i data-lucide="power" class="w-4 h-4"></i> CERRAR JORNADA
                                </button>
                            </div>
                        </div>

                    <div class="glass-panel rounded-2xl overflow-hidden">
                        <div class="p-6 border-b border-gray-800"><h2 class="text-xl font-bold text-white">Todas las Ventas de la Jornada</h2></div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left text-sm text-gray-400">
                                <thead class="bg-gray-900/50 uppercase font-semibold text-gray-500">
                                    <tr>
                                        <th class="px-6 py-4">Ticket ID</th>
                                        <th class="px-6 py-4">Hora</th>
                                        <th class="px-6 py-4">Empleado</th>
                                        <th class="px-6 py-4">Items</th>
                                        <th class="px-6 py-4 text-right">Total</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-800">
                                    ${sales.length === 0 ? `
                                        <tr><td colspan="5" class="px-6 py-8 text-center text-gray-500 italic">No hay ventas registradas.</td></tr>
                                    ` : sales.slice().reverse().map(s => `
                                            <tr onclick="window.posApp.openSaleDetails('${s.id}')" class="hover:bg-gray-800/30 cursor-pointer transition-colors group">
                                                <td class="px-6 py-4 font-mono text-xs group-hover:text-orange-500 transition-colors">#${s.ticketNumber || s.id.toString().slice(-6)}</td>
                                                <td class="px-6 py-4">${new Date(s.date).toLocaleTimeString()}</td>
                                                <td class="px-6 py-4 text-white">${s.employee}</td>
                                                <td class="px-6 py-4">${s.items.reduce((acc, i) => acc + (i.qty || 1), 0)} items</td>
                                                <td class="px-6 py-4 text-right font-bold text-white">$${(s.total || 0).toFixed(2)}</td>
                                            </tr>
                                        `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                    } else if (activeTab === 'inventory') {
                        // Inventory visible to all, but actions restricted
                        const totalItems = inventory.length;
                        const lowStockItems = inventory.filter(i => i.quantity <= i.alert).length;

                        content = `
                        <div class="glass-panel rounded-2xl overflow-hidden mb-10">
                            <div class="p-6 border-b border-gray-800 flex justify-between items-center">
                                <div>
                                    <h2 class="text-xl font-bold text-white">Inventario (Ingredientes)</h2>
                                    <p class="text-gray-400 text-sm">${totalItems} items, ${lowStockItems} con stock bajo</p>
                                </div>
                                ${isManager ? `
                                    <button onclick="window.posApp.handleAddInventoryItem()" class="bg-orange-600 hover:bg-orange-500 text-white px-3 py-1.5 rounded-lg text-sm font-bold flex items-center gap-2">
                                        <i data-lucide="plus" class="w-4 h-4"></i> Nuevo Ingrediente
                                    </button>
                                ` : ''}
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full text-left text-sm text-gray-400">
                                     <thead class="bg-gray-900/50 uppercase font-semibold text-gray-500">
                                        <tr>
                                            <th class="px-6 py-4">Ingrediente</th>
                                            <th class="px-6 py-4">Unidad</th>
                                            <th class="px-6 py-4">Cantidad Actual</th>
                                            <th class="px-6 py-4">Estado</th>
                                            <th class="px-6 py-4 text-right">Acciones</th>
                                        </tr>
                                     </thead>
                                     <tbody class="divide-y divide-gray-800">
                                        ${inventory.map(item => {
                            const isLow = item.quantity <= item.alert;
                            return `
                                            <tr class="hover:bg-gray-800/30 transition-colors">
                                                <td class="px-6 py-4 font-medium text-white">
                                                    <div>${item.name}</div>
                                                    <div class="text-xs text-gray-600 font-mono">${item.id}</div>
                                                </td>
                                                <td class="px-6 py-4">${item.unit}</td>
                                                <td class="px-6 py-4">
                                                    <span class="font-mono text-lg ${isLow ? 'text-red-500 font-bold' : 'text-white'}">
                                                        ${item.quantity}
                                                    </span>
                                                </td>
                                                <td class="px-6 py-4">
                                                    ${isLow
                                    ? `<span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-medium bg-red-500/10 text-red-500 border border-red-500/20"><div class="w-1.5 h-1.5 rounded-full bg-red-500 animate-pulse"></div> Crítico</span>`
                                    : `<span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium bg-green-500/10 text-green-500 border border-green-500/20">OK</span>`
                                }
                                                </td>
                                                <td class="px-6 py-4 text-right flex items-center justify-end gap-2">
                                                    ${isManager || (store.currentUser && store.currentUser.id === 1) ? `
                                                        <button onclick="window.posApp.openRestockModal('${item.id}')" class="text-green-500 hover:text-white hover:bg-green-600 px-3 py-1.5 rounded-lg transition-colors text-xs font-bold border border-green-500/30">
                                                            <i data-lucide="plus" class="w-3 h-3 inline mr-1"></i>Reponer
                                                        </button>
                                                    ` : ''}

                                                    ${isManager ? `
                                                        <button onclick="window.posApp.openAdjustmentModal('${item.id}')" class="text-orange-500 hover:text-white hover:bg-orange-600 px-3 py-1.5 rounded-lg transition-colors text-xs font-bold border border-orange-500/30">
                                                            <i data-lucide="settings-2" class="w-3 h-3 inline mr-1"></i>Ajustar
                                                        </button>
                                                        <button onclick="window.posApp.handleDeleteInventoryItem('${item.id}')" class="p-2 text-red-500 hover:bg-red-500/10 rounded-lg transition-colors" title="Eliminar">
                                                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                                                        </button>
                                                    ` : ''}
                                                    
                                                    ${!isManager && (store.currentUser && store.currentUser.id !== 1) ? `
                                                        <span class="text-gray-600 text-xs italic"><i data-lucide="lock" class="w-3 h-3 inline"></i></span>
                                                    ` : ''}
                                                </td>
                                            </tr>`;
                        }).join('')}
                                     </tbody>
                                </table>
                            </div>
                            </div>
                        </div>
                    `;
                    } else if (activeTab === 'products') {
                        if (!isManager) {
                            content = '<div class="p-10 text-center text-red-500">Acceso restringido a Gerentes.</div>';
                        } else {
                            content = `
                        <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold text-white">Gestión de Productos</h2>
                        <button onclick="window.posApp.openProductEditor()" class="bg-orange-600 hover:bg-orange-500 text-white px-4 py-2 rounded-lg font-bold flex items-center gap-2">
                            <i data-lucide="plus" class="w-4 h-4"></i> Nuevo Producto
                        </button>
                    </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            ${products.map(p => `
                                    <div class="glass-panel p-4 rounded-xl flex gap-4 group relative">
                                        <img src="${p.image}" class="w-20 h-20 rounded-lg object-cover bg-gray-800">
                                        <div class="flex-1">
                                            <h3 class="font-bold text-white mb-1">${p.name}</h3>
                                            <p class="text-orange-500 font-bold">$${p.price}</p>
                                        </div>
                                        <div class="absolute top-2 right-2 flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                            <button onclick="window.posApp.openProductEditor('${p.id}')" class="p-2 bg-gray-800 rounded-lg text-gray-400 hover:text-white" title="Editar">
                                                <i data-lucide="edit-2" class="w-4 h-4"></i>
                                            </button>
                                            ${isManager ? `
                                                <button onclick="window.posApp.deleteProduct('${p.id}')" class="p-2 bg-red-500/10 rounded-lg text-red-500 hover:bg-red-500 hover:text-white transition-colors" title="Eliminar">
                                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                                </button>
                                            ` : ''}
                                        </div>
                                    </div>
                                `).join('')}
                        </div>
                    `;
                        }
                    } else if (activeTab === 'categories') {
                        if (!isManager) {
                            content = '<div class="p-10 text-center text-red-500">Acceso restringido a Gerentes.</div>';
                        } else {
                            content = `
                        <div class="glass-panel rounded-2xl overflow-hidden mb-10 max-w-2xl">
                            <div class="p-6 border-b border-gray-800 flex justify-between items-center">
                                <h2 class="text-xl font-bold text-white">Categorías</h2>
                                <button onclick="window.posApp.handleAddCategory()" class="bg-orange-600 hover:bg-orange-500 text-white px-3 py-1.5 rounded-lg text-sm font-bold flex items-center gap-2">
                                    <i data-lucide="plus" class="w-4 h-4"></i> Nueva
                                </button>
                            </div>
                            <div class="p-4 space-y-2">
                                ${(store.state.categories || []).map(cat => `
                                    <div class="flex items-center justify-between bg-gray-900/50 p-3 rounded-xl border border-gray-800">
                                        <span class="text-white font-medium pl-2">${cat.name}</span>
                                        <button onclick="window.posApp.handleDeleteCategory('${cat.id}')" class="p-2 text-red-500 hover:bg-red-500/10 rounded-lg transition-colors" title="Eliminar">
                                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                                        </button>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                `;
                        }
                    } else if (activeTab === 'users') {
                        if (!isMaster) {
                            content = '<div class="p-10 text-center text-red-500">Acceso restringido a Master.</div>';
                        } else {
                            content = `
                                <div class="glass-panel rounded-2xl overflow-hidden mb-10 max-w-2xl">
                                    <div class="p-6 border-b border-gray-800">
                                        <h2 class="text-xl font-bold text-white">Gestión de Accesos (Usuarios)</h2>
                                        <p class="text-gray-400 text-sm">El Usuario Master puede modificar los PINs de acceso.</p>
                                    </div>
                                    <div class="p-4 space-y-3">
                                        ${store.state.users.map(u => `
                                            <div class="flex items-center justify-between bg-gray-900/50 p-4 rounded-xl border border-gray-800 hover:border-orange-500/30 transition-colors">
                                                <div>
                                                    <span class="text-white font-bold block">${u.name}</span>
                                                    <span class="text-gray-500 text-xs font-mono">ID: ${u.id} | Rol: ${u.id === 3 ? 'Master' : (u.id === 2 ? 'Gerente' : 'Cajero')}</span>
                                                </div>
                                                <button onclick="window.posApp.handleUpdatePin(${u.id})" class="bg-gray-800 hover:bg-orange-600 text-white px-4 py-2 rounded-lg text-sm font-bold border border-gray-700 transition-all flex items-center gap-2">
                                                    <i data-lucide="key" class="w-4 h-4"></i> Cambiar PIN
                                                </button>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            `;
                        }
                    } else {
                        content = `<div class="p-10 text-white text-xl">Tab: ${activeTab}</div>`;
                    }

                    return `
                        <div class="flex-1 h-full p-8 overflow-y-auto bg-gray-950">
                            <header class="mb-6">
                                <div class="flex items-center gap-3">
                                    <h1 class="text-3xl font-bold text-white">Panel de Administración</h1>
                                    ${!isManager ? '<span class="px-3 py-1 bg-gray-800 text-gray-500 text-sm rounded-full border border-gray-700">Vista Cajero</span>' : '<span class="px-3 py-1 bg-orange-600/20 text-orange-500 text-sm rounded-full border border-orange-500/30">Vista Gerente</span>'}
                                </div>
                            </header>
                        ${renderTabs()}
                        ${content}
                    </div>
                        `;
                } catch (e) {
                    console.error("Render Admin Error:", e);
                    return `<div class="p-10 text-red-500 font-mono text-xl">
                        Error al cargar panel de administración:<br>
                        ${e.message}<br>
                        <small>${e.stack}</small>
                    </div>`;
                }
            },

            renderProductEditorModal(product = null) {
                const isEdit = !!product;
                const p = product || { id: '', name: '', price: '', image: '', category: 'burgers' };

                return `
                        <div class="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm" id="editor-modal">
                            <div class="glass-panel w-full max-w-lg rounded-2xl p-6 shadow-2xl animate-in zoom-in-95">
                                <h2 class="text-2xl font-bold text-white mb-6">${isEdit ? 'Editar Producto' : 'Nuevo Producto'}</h2>

                                <form onsubmit="window.posApp.saveProduct(event, '${p.id}')" class="space-y-4">
                                    <div>
                                        <label class="block text-sm text-gray-400 mb-1">Nombre</label>
                                        <input type="text" name="name" value="${p.name}" required class="w-full bg-gray-900 border border-gray-700 rounded-lg p-3 text-white focus:border-orange-500 outline-none">
                                    </div>
                                    <div class="grid grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm text-gray-400 mb-1">Precio</label>
                                            <input type="number" step="0.01" name="price" value="${p.price}" required class="w-full bg-gray-900 border border-gray-700 rounded-lg p-3 text-white focus:border-orange-500 outline-none">
                                        </div>
                                        <div>
                                            <label class="block text-sm text-gray-400 mb-1">Categoría</label>
                                            <select name="category" class="w-full bg-gray-900 border border-gray-700 rounded-lg p-3 text-white focus:border-orange-500 outline-none">
                                                ${(store.state.categories || []).map(cat => `
                                                <option value="${cat.id}" ${p.category === cat.id ? 'selected' : ''}>${cat.name}</option>
                                            `).join('')}
                                            </select>
                                        </div>
                                    </div>
                                    <div>
                                        <label class="block text-sm text-gray-400 mb-1">Imagen URL</label>
                                        <div class="flex gap-2">
                                            <input type="url" name="image" id="img-url-input" value="${p.image}" placeholder="https://..." class="flex-1 bg-gray-900 border border-gray-700 rounded-lg p-3 text-white text-sm focus:border-orange-500 outline-none">
                                                <label class="cursor-pointer bg-gray-800 hover:bg-gray-700 text-white p-3 rounded-lg border border-gray-700">
                                                    <i data-lucide="upload" class="w-5 h-5"></i>
                                                    <input type="file" class="hidden" accept="image/*" onchange="window.posApp.handleImageUpload(this)">
                                                </label>
                                        </div>
                                        <p class="text-xs text-gray-500 mt-1">Pega una URL o sube una imagen (se guardará en el navegador)</p>
                                    </div>

                                    <div class="flex justify-between mt-8">
                                        <div>
                                            ${isEdit && store.currentUser.id === 2 ? `
                                            <button type="button" onclick="window.posApp.deleteProduct('${p.id}')" class="px-4 py-2 bg-red-500/10 text-red-500 hover:bg-red-500 hover:text-white rounded-lg font-bold border border-red-500/20 transition-colors">
                                                <i data-lucide="trash-2" class="w-4 h-4 inline mr-1"></i> Eliminar
                                            </button>
                                        ` : ''}
                                        </div>
                                        <div class="flex gap-3">
                                            <button type="button" onclick="document.getElementById('editor-modal').remove()" class="px-4 py-2 text-gray-400 hover:text-white">Cancelar</button>
                                            <button type="submit" class="px-6 py-2 bg-orange-600 hover:bg-orange-500 text-white rounded-lg font-bold shadow-lg shadow-orange-900/20">Guardar</button>
                                        </div>
                                    </div>

                                    ${store.currentUser.id === 2 ? `
                                    <div class="border-t border-gray-800 pt-6 mt-6">
                                        <h3 class="text-white font-bold mb-4 flex items-center gap-2">
                                            <i data-lucide="chef-hat" class="w-4 h-4 text-orange-500"></i> Receta (Ingredientes)
                                        </h3>
                                        <p class="text-xs text-gray-500 mb-4">Define los ingredientes que se consumen del inventario al vender este producto.</p>
                                        
                                        <div class="space-y-3 mb-4 max-h-40 overflow-y-auto custom-scrollbar" id="recipe-list">
                                             ${(p.recipe || []).map(ing => {
                    const invItem = store.state.inventory.find(i => i.id === ing.id);
                    return `
                                                    <div class="flex gap-2 items-center bg-gray-800/50 p-2 rounded-lg border border-gray-700/50">
                                                        <div class="flex-1 min-w-0">
                                                            <span class="text-gray-300 text-sm font-medium block truncate">${invItem ? invItem.name : ing.id}</span>
                                                            <span class="text-xs text-gray-500">Id: ${ing.id}</span>
                                                        </div>
                                                        <input type="number" step="0.001" name="recipe_qty_${ing.id}" value="${ing.qty}" class="w-20 bg-gray-900 border border-gray-700 rounded p-1.5 text-white text-sm focus:border-orange-500 outline-none text-right">
                                                        <span class="text-gray-500 text-xs w-8">${invItem ? invItem.unit : ''}</span>
                                                        <input type="hidden" name="recipe_id[]" value="${ing.id}">
                                                        <button type="button" onclick="this.closest('.flex').remove()" class="text-red-500 hover:bg-red-500/10 p-1.5 rounded transition-colors" title="Quitar Ingrediente">
                                                            <i data-lucide="trash" class="w-4 h-4"></i>
                                                        </button>
                                                     </div>
                                                 `;
                }).join('')}
                                        </div>

                                        <div class="flex gap-2 bg-gray-900 p-2 rounded-lg border border-gray-800">
                                            <select id="new-ing-select" class="flex-1 bg-gray-800 border-none rounded-lg p-2 text-white text-sm focus:ring-1 focus:ring-orange-500 outline-none cursor-pointer hover:bg-gray-700 transition-colors">
                                                <option value="" disabled selected>-- Seleccionar Ingrediente --</option>
                                                ${store.state.inventory.map(i => `<option value="${i.id}">${i.name} (${i.unit})</option>`).join('')}
                                            </select>
                                            <button type="button" onclick="window.posApp.addIngredientRow()" class="bg-orange-600 hover:bg-orange-500 text-white px-4 rounded-lg font-bold shadow-lg transition-colors flex items-center justify-center">
                                                <i data-lucide="plus" class="w-4 h-4"></i>
                                            </button>
                                        </div>
                                    </div>
                                ` : ''}
                                </form>
                            </div>
                            </div>
                </div>
            </div>
                        `;
            },

            renderSaleDetailsModal(sale) {
                return `
                    <div class="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm" id="sale-modal">
                        <div class="glass-panel w-full max-w-md rounded-2xl p-6 shadow-2xl animate-in zoom-in-95 relative">
                            <button onclick="document.getElementById('sale-modal').remove()" class="absolute top-4 right-4 p-2 hover:bg-gray-800 rounded-lg text-gray-400 hover:text-white transition-colors">
                                <i data-lucide="x" class="w-5 h-5"></i>
                            </button>
                            
                            <div class="text-center mb-6">
                                <div class="w-12 h-12 bg-orange-500/20 text-orange-500 rounded-full flex items-center justify-center mx-auto mb-3">
                                    <i data-lucide="receipt" class="w-6 h-6"></i>
                                </div>
                                <h2 class="text-2xl font-bold text-white">Ticket #${sale.ticketNumber || sale.id.toString().slice(-6)}</h2>
                                <p class="text-gray-400 text-sm">${new Date(sale.date).toLocaleString()}</p>
                                <p class="text-gray-500 text-xs mt-1">Atendido por: ${sale.employee}</p>
                            </div>

                            <div class="space-y-3 mb-6 max-h-[60vh] overflow-y-auto pr-2 custom-scrollbar">
                                ${sale.items.map(item => `
                                    <div class="flex justify-between items-center p-3 bg-gray-900/50 rounded-xl border border-gray-800">
                                        <div class="flex items-center gap-3">
                                            <div class="w-8 h-8 rounded-lg bg-gray-800 flex items-center justify-center text-xs font-bold text-gray-400">
                                                ${item.qty || 1}x
                                            </div>
                                            <div>
                                                <p class="text-white font-medium text-sm">${item.product ? item.product.name : (item.name || 'Unknown')}</p>
                                                <p class="text-gray-500 text-xs">$${(item.product ? item.product.price : (item.price || 0)).toFixed(2)} c/u</p>
                                            </div>
                                        </div>
                                        <p class="text-white font-bold">$${((item.product ? item.product.price : (item.price || 0)) * (item.qty || 1)).toFixed(2)}</p>
                                    </div>
                                `).join('')}
                            </div>

                            <div class="flex justify-between items-end pt-4 border-t border-gray-800">
                                <span class="text-gray-400">Total Pagado</span>
                                <span class="text-3xl font-bold text-orange-500">$${(sale.total || 0).toFixed(2)}</span>
                            </div>
                        </div>
                    </div>
                `;
            },

            renderPinModal(targetPin, userName) {
                return `
                        <div class="fixed inset-0 z-50 flex items-center justify-center bg-black/90 backdrop-blur-md" id="pin-modal">
                            <div class="glass-panel w-80 rounded-2xl p-6 shadow-2xl flex flex-col items-center animate-in zoom-in-95">
                                <div class="w-12 h-12 bg-gray-800 rounded-full flex items-center justify-center mb-4 text-orange-500">
                                    <i data-lucide="lock" class="w-6 h-6"></i>
                                </div>
                                <h2 class="text-xl font-bold text-white mb-1">Ingrese PIN</h2>
                                <p class="text-gray-400 text-sm mb-6">Para ${userName}</p>

                                <div class="flex gap-2 justify-center mb-6">
                                    <div id="pin-dot-1" class="w-3 h-3 rounded-full bg-gray-700 transition-colors"></div>
                                    <div id="pin-dot-2" class="w-3 h-3 rounded-full bg-gray-700 transition-colors"></div>
                                    <div id="pin-dot-3" class="w-3 h-3 rounded-full bg-gray-700 transition-colors"></div>
                                    <div id="pin-dot-4" class="w-3 h-3 rounded-full bg-gray-700 transition-colors"></div>
                                </div>

                                <div class="grid grid-cols-3 gap-3 w-full mb-4">
                                    ${[1, 2, 3, 4, 5, 6, 7, 8, 9].map(n => `
                                    <button onclick="window.posApp.enterPinDigit('${n}', '${targetPin}')" class="h-14 rounded-xl bg-gray-800 hover:bg-gray-700 text-white text-xl font-bold transition-colors">${n}</button>
                                `).join('')}
                                    <button onclick="document.getElementById('pin-modal').remove(); window.posApp.currentPinInput=''" class="h-14 rounded-xl bg-gray-800 hover:bg-red-900/30 text-red-500 flex items-center justify-center transition-colors"><i data-lucide="x" class="w-5 h-5"></i></button>
                                    <button onclick="window.posApp.enterPinDigit('0', '${targetPin}')" class="h-14 rounded-xl bg-gray-800 hover:bg-gray-700 text-white text-xl font-bold transition-colors">0</button>
                                    <button onclick="window.posApp.backspacePin()" class="h-14 rounded-xl bg-gray-800 hover:bg-gray-700 text-gray-400 hover:text-white flex items-center justify-center transition-colors"><i data-lucide="delete" class="w-5 h-5"></i></button>
                                </div>
                            </div>
            </div>
                        `;
            },

            renderProductModal(productId) {
                const store = window.store; // Safely get store
                const product = store.state.products.find(p => p.id === productId);
                if (!product) return '';

                return `
                        <div class="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm animate-in fade-in duration-200" id="product-modal">
                            <div class="glass-panel w-full max-w-md rounded-3xl overflow-hidden shadow-2xl scale-100 animate-in zoom-in-95 duration-200">
                                <div class="relative h-48">
                                    <img src="${product.image}" class="w-full h-full object-cover">
                                        <button onclick="window.posApp.closeModal()" class="absolute top-4 right-4 w-10 h-10 rounded-full bg-black/50 hover:bg-black/70 flex items-center justify-center text-white backdrop-blur-md transition-colors">
                                            <i data-lucide="x" class="w-6 h-6"></i>
                                        </button>
                                </div>

                                <div class="p-6">
                                    <div class="flex justify-between items-start mb-2">
                                        <h2 class="text-2xl font-bold text-white">${product.name}</h2>
                                        <span class="text-2xl font-bold text-orange-500">$${product.price}</span>
                                    </div>
                                    <p class="text-gray-400 text-sm mb-6">Personaliza tu orden a continuación.</p>

                                    <div class="space-y-4 mb-8">
                                        <label class="block text-sm font-medium text-gray-300">Notas especiales</label>
                                        <textarea id="modal-notes" class="w-full bg-gray-900/50 border border-gray-700 rounded-xl p-3 text-white focus:border-orange-500 focus:ring-1 focus:ring-orange-500 outline-none transition-all placeholder:text-gray-600" rows="3" placeholder="Ej: Sin cebolla, extra salsa..."></textarea>
                                    </div>

                                    <button onclick="window.posApp.addToCartFromModal('${product.id}')" class="w-full py-4 rounded-xl bg-orange-600 hover:bg-orange-500 text-white font-bold text-lg shadow-lg shadow-orange-900/20 transition-all flex items-center justify-center gap-2">
                                        Agregar a la Orden
                                    </button>
                                </div>
                            </div>
            </div>
            `;
            },

            renderAdjustmentModal(itemId) {
                const store = window.store;
                const item = store.state.inventory.find(i => i.id === itemId);
                if (!item) return '';

                return `
                    <div class="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm" id="adjustment-modal">
                        <div class="glass-panel w-full max-w-md rounded-2xl p-6 shadow-2xl animate-in zoom-in-95 border border-orange-500/20">
                            <div class="flex items-center gap-3 mb-6 border-b border-gray-800/50 pb-4">
                                <div class="w-10 h-10 rounded-full bg-orange-500/20 flex items-center justify-center text-orange-500">
                                    <i data-lucide="clipboard-edit" class="w-5 h-5"></i>
                                </div>
                                <div>
                                    <h2 class="text-xl font-bold text-white">Ajustar Inventario</h2>
                                    <p class="text-gray-400 text-sm">${item.name}</p>
                                </div>
                            </div>
                            
                            <form onsubmit="window.posApp.handleAdjustment(event, '${item.id}')" class="space-y-4">
                                <div class="bg-gray-800/50 p-4 rounded-xl border border-gray-700/50 mb-4">
                                    <label class="block text-xs uppercase tracking-wider text-gray-500 mb-1">Cantidad Actual</label>
                                    <div class="text-2xl font-mono font-bold text-white">${item.quantity} <span class="text-sm text-gray-400 font-sans font-normal">${item.unit}</span></div>
                                </div>

                                <div>
                                    <label class="block text-sm text-gray-300 mb-1 font-medium">Nueva Cantidad Total</label>
                                    <input type="number" step="0.001" name="quantity" value="${item.quantity}" required class="w-full bg-gray-900 border border-gray-700 rounded-lg p-3 text-white focus:border-orange-500 outline-none font-mono text-lg">
                                    <p class="text-xs text-gray-500 mt-1">Ingrese el valor real contado en físico.</p>
                                </div>

                                <div>
                                    <label class="block text-sm text-gray-300 mb-1 font-medium">Motivo del Ajuste (Obligatorio)</label>
                                    <textarea name="note" required rows="3" placeholder="Ej: Error en conteo, Desperdicio, Merma..." class="w-full bg-gray-900 border border-gray-700 rounded-lg p-3 text-white focus:border-orange-500 outline-none placeholder:text-gray-600"></textarea>
                                </div>

                                <div class="flex gap-3 mt-6 pt-4 border-t border-gray-800/50">
                                    <button type="button" onclick="document.getElementById('adjustment-modal').remove()" class="flex-1 px-4 py-3 bg-gray-800 hover:bg-gray-700 text-white rounded-xl font-bold transition-colors">
                                        Cancelar
                                    </button>
                                    <button type="submit" class="flex-1 px-4 py-3 bg-orange-600 hover:bg-orange-500 text-white rounded-xl font-bold shadow-lg shadow-orange-900/20 transition-colors">
                                        Guardar Ajuste
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;
            },

            renderRestockModal(itemId) {
                const store = window.store;
                const item = store.state.inventory.find(i => i.id === itemId);
                if (!item) return '';

                return `
                    <div class="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm" id="restock-modal">
                        <div class="glass-panel w-full max-w-md rounded-2xl p-6 shadow-2xl animate-in zoom-in-95 border border-green-500/20">
                            <div class="flex items-center gap-3 mb-6 border-b border-gray-800/50 pb-4">
                                <div class="w-10 h-10 rounded-full bg-green-500/20 flex items-center justify-center text-green-500">
                                    <i data-lucide="package-plus" class="w-5 h-5"></i>
                                </div>
                                <div>
                                    <h2 class="text-xl font-bold text-white">Reponer Inventario</h2>
                                    <p class="text-gray-400 text-sm">${item.name}</p>
                                </div>
                            </div>
                            
                            <form onsubmit="window.posApp.handleRestock(event, '${item.id}')" class="space-y-4">
                                <div class="bg-gray-800/50 p-4 rounded-xl border border-gray-700/50 mb-4">
                                    <label class="block text-xs uppercase tracking-wider text-gray-500 mb-1">Stock Actual</label>
                                    <div class="text-2xl font-mono font-bold text-white">${item.quantity} <span class="text-sm text-gray-400 font-sans font-normal">${item.unit}</span></div>
                                </div>

                                <div>
                                    <label class="block text-sm text-gray-300 mb-1 font-medium">Cantidad a Agregar</label>
                                    <input type="number" step="0.001" name="quantity_add" value="" required min="0.001" placeholder="Ej: 10" class="w-full bg-gray-900 border border-gray-700 rounded-lg p-3 text-white focus:border-green-500 outline-none font-mono text-lg">
                                    <p class="text-xs text-gray-500 mt-1">Esta cantidad se sumará al stock actual.</p>
                                </div>

                                <div class="flex gap-3 mt-6 pt-4 border-t border-gray-800/50">
                                    <button type="button" onclick="document.getElementById('restock-modal').remove()" class="flex-1 px-4 py-3 bg-gray-800 hover:bg-gray-700 text-white rounded-xl font-bold transition-colors">
                                        Cancelar
                                    </button>
                                    <button type="submit" class="flex-1 px-4 py-3 bg-green-600 hover:bg-green-500 text-white rounded-xl font-bold shadow-lg shadow-green-900/20 transition-colors">
                                        Confirmar
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;
            }
        };
    </script>

    <!-- 3. APP CONTROLLER -->
    <script>
        const store = window.store;
        const views = window.views;

        // DOM Elements
        const appDiv = document.getElementById('app');

        // State
        let activeView = 'pos';

        // Setup Global Namespace
        window.posApp = {
            adminTab: 'dashboard',
            currentPinInput: '',

            login: function (pin) { return store.login(pin); },
            logout: function () { return store.logout(); },
            addToCart: function (product) { return store.addToCart(product); },
            removeFromCart: function (id) { return store.decreaseCartItem(id); }, // Now decreases qty
            clearCart: function () { return store.clearCart(); },
            checkout: handleCheckout,
            openProductModal: openProductModal,
            closeModal: closeProductModal,
            addToCartFromModal: addToCartFromModal,
            setView: setView,
            setAdminTab: setAdminTab,
            addStock: handleAddStock,
            openAdjustmentModal: openAdjustmentModal,
            handleAdjustment: handleAdjustment,
            openRestockModal: openRestockModal,
            handleRestock: handleRestock,
            setManualRate: function () {
                const current = store.state.bcvRate ? store.state.bcvRate.rate : 0;
                const val = prompt("Ingrese Tasa BCV Manual (Bs):", current > 0 ? current : "");
                if (val && !isNaN(val)) {
                    store.updateRate(parseFloat(val), true);
                    alert("Tasa actualizada manualmente.");
                }
            },

            // PIN
            requestPin: requestPin,
            enterPinDigit: enterPinDigit,
            backspacePin: backspacePin,

            // Sales History
            openSaleDetails: function (id) {
                const sale = store.state.sales.find(s => s.id == id);
                if (sale) {
                    const modal = views.renderSaleDetailsModal(sale);
                    document.getElementById('modal-container').innerHTML = modal;
                    requestAnimationFrame(() => window.lucide.createIcons());
                }
            },

            // Product Manager
            openProductEditor: openProductEditor,
            handleImageUpload: handleImageUpload,
            saveProduct: saveProduct,
            deleteProduct: handleDeleteProduct,
            addIngredientRow: addIngredientRow,

            // Categories
            activeCategory: 'all',
            filterCategory: function (catId) {
                this.activeCategory = catId;
                store.notify();
            },
            handleAddCategory: handleAddCategory,
            handleDeleteCategory: handleDeleteCategory,

            // Inventory
            handleAddInventoryItem: handleAddInventoryItem,
            handleDeleteInventoryItem: handleDeleteInventoryItem,

            handleCloseSession: function () {
                if (confirm('¿Confirmar CIERRE DE VENTAS? Se eliminarán todas las ventas de la sesión actual.')) {
                    store.closeSession();
                    alert('Jornada cerrada correctamente.');
                }
            },

            handleUpdatePin: function (userId) {
                const newPin = prompt("Ingrese el nuevo PIN de 4 dígitos:");
                if (newPin) {
                    if (newPin.length !== 4 || isNaN(newPin)) {
                        alert("El PIN debe ser de exactamente 4 números.");
                        return;
                    }
                    if (store.updateUserPin(userId, newPin)) {
                        alert("PIN actualizado correctamente.");
                    }
                }
            },

            handlePrintSessionReport: function () {
                const sales = store.state.sales;
                const total = sales.reduce((sum, s) => sum + (s.total || 0), 0);
                const date = new Date().toLocaleString();

                const printContent = `
                    <html>
                    <head>
                        <title>Reporte de Jornada - ${date}</title>
                        <style>
                            body { font-family: monospace; padding: 20px; }
                            h1 { text-align: center; border-bottom: 2px solid #000; padding-bottom: 10px; }
                            .summary { margin-bottom: 20px; font-weight: bold; }
                            table { w-full; border-collapse: collapse; margin-top: 20px; width: 100%; }
                            th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                            th { background-color: #f2f2f2; }
                            .text-right { text-align: right; }
                            .grand-total { text-align: right; font-size: 1.5em; font-weight: bold; margin-top: 20px; }
                        </style>
                    </head>
                    <body>
                        <h1>Reporte de Cierre de Jornada</h1>
                        <div class="summary">
                            <p>Fecha: ${date}</p>
                            <p>Total Transacciones: ${sales.length}</p>
                            <p>Generado por: ${store.currentUser.name}</p>
                        </div>

                        <table>
                            <thead>
                                <tr>
                                    <th>Ticket</th>
                                    <th>Hora</th>
                                    <th>Empleado</th>
                                    <th>Monto</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${sales.map(s => `
                                    <tr>
                                        <td>#${s.ticketNumber || s.id.toString().slice(-6)}</td>
                                        <td>${new Date(s.date).toLocaleTimeString()}</td>
                                        <td>${s.employee}</td>
                                        <td class="text-right">$${(s.total || 0).toFixed(2)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>

                        <div class="grand-total">
                            Total Venta: $${total.toFixed(2)}
                        </div>
                    </body>
                    </html>
                `;

                const printWindow = window.open('', '', 'width=800,height=600');
                printWindow.document.write(printContent);
                printWindow.document.close();
                printWindow.focus();
                setTimeout(() => {
                    printWindow.print();
                    printWindow.close();
                }, 250);
            }
        };

        // --- Initialization ---
        function init() {
            store.subscribe((currentStore) => {
                render(currentStore);
            });
            // Initial Fetch of BCV Rate
            store.fetchBCVRate();
            // Refresh every 10 minutes (optional but good for long sessions)
            setInterval(() => store.fetchBCVRate(), 10 * 60 * 1000);
        }

        // --- Rendering Loop ---
        function render(s) {
            // Re-init icons
            requestAnimationFrame(() => {
                if (window.lucide) window.lucide.createIcons();
            });

            // 1. Check Login
            if (!s.currentUser) {
                appDiv.innerHTML = views.renderLogin();
                return;
            }

            // 2. Main Layout
            // 2. Main Layout
            appDiv.innerHTML = `
                        <div class="flex h-full w-full bg-gray-950 text-white">
                     <!-- Navigation Sidebar -->
                     <aside class="w-20 flex flex-col items-center py-6 bg-gray-900 border-r border-gray-800 z-30 shadow-xl">
                        <div class="mb-4 p-2 bg-gradient-to-br from-orange-500 to-orange-700 rounded-xl shadow-lg shadow-orange-900/50">
                            <i data-lucide="flame" class="w-8 h-8 text-white"></i>
                        </div>

                         <!-- Tasa BCV Widget -->
                        <div class="mb-4 flex flex-col items-center text-center px-1">
                            <div class="flex items-center gap-1 mb-1">
                                <span class="text-[10px] text-gray-500 font-bold uppercase tracking-wider">BCV</span>
                                <button onclick="window.store.fetchBCVRate()" class="text-gray-600 hover:text-white transition-colors" title="Actualizar Tasa">
                                    <i data-lucide="refresh-cw" class="w-3 h-3"></i>
                                </button>
                            </div>
                            <button onclick="window.posApp.setManualRate()" class="block cursor-pointer hover:scale-105 transition-transform" title="Click para ajustar manual">
                                <div class="text-xs font-bold ${s.bcvRate && s.bcvRate.rate > 0 ? (s.bcvRate.isManual ? 'text-orange-400' : 'text-green-500') : 'text-red-500'} font-mono">
                                    ${s.bcvRate && s.bcvRate.rate > 0 ? 'Bs.' + s.bcvRate.rate.toFixed(2) : (s.bcvRate && s.bcvRate.rate === -1 ? 'Err API' : 'Cargando...')}
                                </div>
                                ${s.bcvRate && s.bcvRate.isManual ? '<span class="text-[8px] text-orange-500/70 block uppercase">Manual</span>' : ''}
                            </button>
                        </div>
                        
                        <nav class="flex-1 flex flex-col gap-6 w-full items-center">
                            <button onclick="window.posApp.setView('pos')" 
                                class="p-3 rounded-2xl transition-all duration-300 group ${activeView === 'pos' ? 'bg-orange-600 text-white shadow-lg shadow-orange-900/40 translate-x-1' : 'hover:bg-gray-800 text-gray-500 hover:text-gray-300'}">
                                <i data-lucide="layout-grid" class="w-6 h-6"></i>
                            </button>
                            <button onclick="window.posApp.setView('admin')" 
                                class="p-3 rounded-2xl transition-all duration-300 group ${activeView === 'admin' ? 'bg-orange-600 text-white shadow-lg shadow-orange-900/40 translate-x-1' : 'hover:bg-gray-800 text-gray-500 hover:text-gray-300'}">
                                <i data-lucide="package" class="w-6 h-6"></i>
                            </button>
                        </nav>

                        <div class="flex flex-col gap-4 items-center mb-4">
                             <div class="w-10 h-10 rounded-full bg-gray-800 border border-gray-700 flex items-center justify-center text-sm font-bold text-gray-300 cursor-help" title="${s.currentUser.name}">
                                ${s.currentUser.name.charAt(0)}
                             </div>
                            <button onclick="window.posApp.logout()" class="p-3 rounded-2xl hover:bg-red-500/10 text-gray-600 hover:text-red-500 transition-colors">
                                <i data-lucide="log-out" class="w-6 h-6"></i>
                            </button>
                        </div>
                     </aside>

                     <!-- Main Content Area -->
                        <main id="main-content" class="flex-1 flex overflow-hidden relative bg-black/20">
                            ${activeView === 'pos' ? views.renderPOS() : views.renderAdmin()}
                        </main>
                </div>
                        `;
        }

        // --- Event Handlers & Logic ---

        function setView(viewName) {
            console.log('SetView called with:', viewName);
            activeView = viewName;
            store.notify();
        }

        function setAdminTab(tab) {
            window.posApp.adminTab = tab;
            store.notify();
        }

        // PIN Logic
        function requestPin(correctPin, userName) {
            window.posApp.currentPinInput = '';
            const modal = views.renderPinModal(correctPin, userName);
            document.getElementById('modal-container').innerHTML = modal;
            requestAnimationFrame(() => window.lucide.createIcons());
        }

        function enterPinDigit(digit, correctPin) {
            window.posApp.currentPinInput += digit;
            updatePinDots();

            if (window.posApp.currentPinInput.length === 4) {
                setTimeout(() => {
                    if (window.posApp.currentPinInput === correctPin) {
                        store.login(correctPin);
                        document.getElementById('modal-container').innerHTML = '';
                    } else {
                        alert('PIN Incorrecto');
                        window.posApp.currentPinInput = '';
                        updatePinDots();
                    }
                }, 300);
            }
        }

        function backspacePin() {
            window.posApp.currentPinInput = window.posApp.currentPinInput.slice(0, -1);
            updatePinDots();
        }

        function updatePinDots() {
            const len = window.posApp.currentPinInput.length;
            for (let i = 1; i <= 4; i++) {
                const dot = document.getElementById(`pin-dot-${i}`);
                if (dot) dot.classList.toggle('bg-orange-500', i <= len);
                if (dot) dot.classList.toggle('bg-gray-700', i > len);
            }
        }

        // Product Manager Logic
        function openProductEditor(productId = null) {
            const product = productId ? store.state.products.find(p => p.id === productId) : null;
            const modal = views.renderProductEditorModal(product);
            document.getElementById('modal-container').innerHTML = modal;
            requestAnimationFrame(() => window.lucide.createIcons());
        }

        function handleImageUpload(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    document.getElementById('img-url-input').value = e.target.result;
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function saveProduct(event, id) {
            event.preventDefault();
            const formData = new FormData(event.target);

            const recipe = [];
            const recipeIds = formData.getAll('recipe_id[]');
            recipeIds.forEach(rId => {
                const qty = formData.get(`recipe_qty_${rId}`);
                if (qty) {
                    recipe.push({ id: rId, qty: parseFloat(qty) });
                }
            });

            const product = {
                id: id && id !== 'undefined' ? id : 'p_' + Date.now(),
                name: formData.get('name'),
                price: parseFloat(formData.get('price')),
                category: formData.get('category'),
                image: formData.get('image') || 'https://via.placeholder.com/150',
                recipe: recipe
            };

            if (id && id !== 'undefined') {
                store.updateProduct(product);
            } else {
                store.addProduct(product);
            }

            document.getElementById('editor-modal').remove();
            // alert('Producto guardado');
        }

        function handleDeleteProduct(id) {
            if (confirm('¿Está seguro de eliminar este producto?\nEsta acción no se puede deshacer.')) {
                store.deleteProduct(id);
                const modal = document.getElementById('editor-modal');
                if (modal) modal.remove();
                store.notify();
            }
        }

        // Inventory Logic
        function handleAddInventoryItem() {
            const name = prompt('Nombre del nuevo ingrediente:');
            if (!name) return;

            const unit = prompt('Unidad de medida (ej: kg, L, unidad):', 'unidad');
            if (!unit) return;

            const quantity = parseFloat(prompt('Cantidad inicial:', '0'));
            if (isNaN(quantity)) return;

            const alertVal = parseFloat(prompt('Alerta de stock bajo (cantidad):', '10'));
            if (isNaN(alertVal)) return;

            const id = 'inv_' + Date.now();
            store.addInventoryItem({ id, name, unit, quantity, alert: alertVal });
        }

        function handleDeleteInventoryItem(id) {
            if (confirm('¿Eliminar este ingrediente del inventario?')) {
                store.deleteInventoryItem(id);
            }
        }

        // Category Logic
        function handleAddCategory() {
            const name = prompt('Nombre de la nueva categoría:');
            if (name) {
                const id = name.toLowerCase().replace(/[^a-z0-9]/g, '_');

                // Safety check
                if (!store.state.categories) {
                    store.state.categories = [];
                }

                if (store.state.categories.find(c => c.id === id)) {
                    alert('Ya existe una categoría con ese identificador.');
                    return;
                }
                store.addCategory({ id, name });
            }
        }

        function handleDeleteCategory(id) {
            if (confirm('¿Eliminar categoría?')) {
                store.deleteCategory(id);
            }
        }

        function addIngredientRow() {
            const select = document.getElementById('new-ing-select');
            const ingId = select.value;

            if (!ingId) {
                alert('Por favor selecciona un ingrediente primero.');
                return;
            }

            const ingText = select.options[select.selectedIndex].text;

            // Check duplication
            const existing = document.querySelector(`input[name = "recipe_id[]"][value = "${ingId}"]`);
            if (existing) {
                alert('Este ingrediente ya está en la lista');
                return;
            }

            const div = document.createElement('div');
            div.className = 'flex gap-2 items-center bg-gray-800/50 p-2 rounded-lg border border-gray-700/50 animate-in fade-in slide-in-from-bottom-2';
            div.innerHTML = `
                <div class="flex-1 min-w-0">
                    <span class="text-gray-300 text-sm font-medium block truncate">${ingText}</span>
                </div>
                <input type="number" step="0.001" name="recipe_qty_${ingId}" value="1" class="w-20 bg-gray-900 border border-gray-700 rounded p-1.5 text-white text-sm focus:border-orange-500 outline-none text-right">
                    <span class="text-gray-500 text-xs w-8"></span>
                    <input type="hidden" name="recipe_id[]" value="${ingId}">
                        <button type="button" onclick="this.closest('.flex').remove()" class="text-red-500 hover:bg-red-500/10 p-1.5 rounded transition-colors" title="Quitar Ingrediente"><i data-lucide="trash" class="w-4 h-4"></i></button>
                        `;
            document.getElementById('recipe-list').appendChild(div);
            requestAnimationFrame(() => window.lucide.createIcons());

            select.value = "";
        }

        function openProductModal(productId) {
            const modalHtml = views.renderProductModal(productId);
            document.getElementById('modal-container').innerHTML = modalHtml;
            requestAnimationFrame(() => window.lucide.createIcons());
        }

        function closeProductModal() {
            document.getElementById('modal-container').innerHTML = '';
        }

        function addToCartFromModal(productId) {
            const notes = document.getElementById('modal-notes').value;
            const product = store.state.products.find(p => p.id === productId);

            if (store.addToCart(product, notes)) {
                closeProductModal();
            }
        }

        function handleAddStock(ingId) {
            // Deprecated - Replaced by Adjustment Modal but kept for reference
            const qty = prompt("Ingrese cantidad a agregar (número):", "10");
            if (qty && !isNaN(qty)) {
                const current = store.state.inventory.find(i => i.id === ingId);
                if (current) {
                    const newTotal = current.quantity + parseFloat(qty);
                    store.updateInventory(ingId, newTotal);
                }
            }
        }

        function openAdjustmentModal(itemId) {
            const modalHtml = views.renderAdjustmentModal(itemId);
            document.getElementById('modal-container').innerHTML = modalHtml;
            requestAnimationFrame(() => window.lucide.createIcons());
        }

        function handleAdjustment(event, itemId) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const newQuantity = parseFloat(formData.get('quantity'));
            const note = formData.get('note');

            if (store.adjustInventory(itemId, newQuantity, note, store.currentUser)) {
                document.getElementById('adjustment-modal').remove();
            }
        }

        function openRestockModal(itemId) {
            const modalHtml = views.renderRestockModal(itemId);
            document.getElementById('modal-container').innerHTML = modalHtml;
            requestAnimationFrame(() => window.lucide.createIcons());
        }

        function handleRestock(event, itemId) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const qtyToAdd = parseFloat(formData.get('quantity_add'));

            if (qtyToAdd > 0) {
                if (store.restockInventory(itemId, qtyToAdd, store.currentUser)) {
                    document.getElementById('restock-modal').remove();
                    alert('Stock agregado correctamente.');
                }
            }
        }

        // Printing Logic
        async function handleCheckout() {
            if (store.cart.length === 0) return;

            // Update Rate before confirming
            await store.fetchBCVRate();
            const rate = store.state.bcvRate ? store.state.bcvRate.rate : 0;
            const rateMsg = rate > 0 ? `\n(Tasa BCV: ${rate.toFixed(2)} Bs)` : '';

            if (confirm(`¿Confirmar venta e imprimir ticket?${rateMsg}`)) {
                const sale = store.checkout();
                if (sale) {
                    printTicket(sale);
                }
            }
        }

        function printTicket(sale) {
            const printArea = document.getElementById('receipt-print-area');
            const date = new Date(sale.date).toLocaleString('es-ES');

            printArea.classList.remove('hidden');
            printArea.style.display = 'block';

            printArea.innerHTML = `
                        <div style="width: 58mm; padding: 10px; font-family: monospace; font-size: 12px; line-height: 1.2;">
                            <div style="text-align: center; margin-bottom: 10px;">
                                <h2 style="margin: 0; font-size: 16px; font-weight: bold;">FLAME & FEAST</h2>
                                <p style="margin: 2px 0;">Fast Food Premium</p>
                                <p style="margin: 2px 0;">----------------</p>
                            </div>

                            <div style="margin-bottom: 5px;">
                                ORDER: #${sale.ticketNumber || sale.id.toString().slice(-4)}<br>
                                    FECHA: ${date}<br>
                                        CAJERO: ${sale.employee}
                                    </div>

                                    <div style="margin-bottom: 10px; border-bottom: 1px dashed black; padding-bottom: 5px;">
                                        ${sale.items.map(item => `
                            <div style="display: flex; justify-content: space-between;">
                                <span>${item.qty} x ${item.product.name}</span>
                                <span>$${(item.product.price * item.qty).toFixed(2)}</span>
                            </div>
                            ${item.notes ? `<div style="font-size: 10px; font-style: italic; margin-left: 10px;">(${item.notes})</div>` : ''}
                        `).join('')}
                                    </div>

                                    <div style="display: flex; justify-content: space-between; font-weight: bold; font-size: 14px; margin-top: 5px;">
                                        <span>TOTAL:</span>
                                        <span>$${sale.total.toFixed(2)}</span>
                                    </div>

                                    <div style="text-align: center; margin-top: 20px;">
                                        <p>¡Gracias por su compra!</p>
                                        <p>www.flameandfeast.com</p>
                                    </div>
                            </div>
            `;

            setTimeout(() => {
                window.print();
            }, 500);
        }

        // Initialize App
        init();
    </script>
</body>

</html>