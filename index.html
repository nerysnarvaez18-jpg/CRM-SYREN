<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Flame & Feast POS</title>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Outfit', 'sans-serif'],
                    },
                    colors: {
                        gray: {
                            850: '#1f2937',
                            900: '#111827',
                            950: '#0B0F19',
                        },
                        accent: {
                            500: '#F97316',
                            600: '#EA580C',
                        }
                    }
                }
            }
        }
    </script>

    <!-- Vector Icons (Lucide) -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- Custom Styles -->
    <style>
        /* Glassmorphism Utilities */
        .glass {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .glass-panel {
            background: rgba(17, 24, 39, 0.6);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /* Base resets */
        body {
            -webkit-tap-highlight-color: transparent;
        }

        /* Select and Option Style Fixes for Dark Mode */
        select,
        option {
            background-color: #111827 !important;
            /* gray-900 */
            color: white !important;
        }

        /* Print Styles for 58mm Thermal Printer */
        @media print {
            body * {
                visibility: hidden;
            }

            #receipt-print-area,
            #receipt-print-area * {
                visibility: visible;
            }

            #receipt-print-area {
                display: block !important;
                position: absolute;
                left: 0;
                top: 0;
                width: 58mm;
                padding: 0;
                margin: 0;
                color: black;
                background: white;
                font-family: 'Courier New', Courier, monospace;
                font-size: 12px;
                z-index: 9999;
            }

            html,
            body {
                height: auto;
                overflow: visible;
                background: white;
            }
        }
    </style>

    <!-- Error Handler -->
    <script>
        window.onerror = function (msg, url, line, col, error) {
            alert("Error: " + msg + "\nLine: " + line + "\nCol: " + col);
            document.getElementById('app').innerHTML = '<div class="text-red-500 p-10 font-mono">Error: ' + msg + '<br>Line: ' + line + '</div>';
        };
    </script>
</head>

<body class="bg-gray-950 text-white font-sans h-screen w-screen overflow-hidden select-none">

    <div id="app" class="h-full w-full flex">
        <div class="m-auto text-gray-500 animate-pulse">Cargando Sistema POS...</div>
    </div>

    <!-- Modals & Print (Always persistent) -->
    <div id="modal-container"></div>
    <div id="receipt-print-area" class="hidden"></div>

    <!-- Application Logic (Inlined for reliability) -->

    <!-- 1. STORE -->
    <script>
        const SUPABASE_URL = 'https://renjxvjkhfuroaqlhllk.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJlbmp4dmpraGZ1cm9hcWxobGxrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg3MDUwNjAsImV4cCI6MjA4NDI4MTA2MH0.I4M15Cp0JsArYs60tKvyreNgg2d0ZD07GDgRsxui5zo';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const STORAGE_KEY = 'pos_data_v1';

        const INITIAL_DATA = {
            users: [
                { id: 1, name: 'Cajero Principal', pin: '1234' },
                { id: 2, name: 'Gerente', pin: '0000' },
                { id: 3, name: 'Master', pin: '9999' }
            ],
            categories: [
                { id: 'burgers', name: 'Hamburguesas' },
                { id: 'sides', name: 'Acompañantes' },
                { id: 'drinks', name: 'Bebidas' }
            ],
            inventory: [
                { id: 'inv_1', name: 'Pan de Hamburguesa', unit: 'unidad', quantity: 100, alert: 20 },
                { id: 'inv_2', name: 'Carne de Res', unit: 'unidad', quantity: 100, alert: 20 },
                { id: 'inv_3', name: 'Queso Cheddar', unit: 'unidad', quantity: 100, alert: 20 },
                { id: 'inv_4', name: 'Papas Congeladas', unit: 'kg', quantity: 50.0, alert: 10.0 },
                { id: 'inv_5', name: 'Cebolla Morada', unit: 'kg', quantity: 10.0, alert: 2.0 },
                { id: 'inv_6', name: 'Salsa Especial', unit: 'L', quantity: 5.0, alert: 1.0 },
                { id: 'inv_7', name: 'Refresco Cola', unit: 'unidad', quantity: 200, alert: 24 }
            ],
            inventory_movements: [],
            bcvRate: { rate: 0, lastUpdated: null }, // BCV Rate State
            products: [
                {
                    id: 'p_1',
                    name: 'Classic Burger',
                    price: 150.00,
                    category: 'burgers',
                    image: 'https://images.unsplash.com/photo-1568901346375-23c9450c58cd?auto=format&fit=crop&w=500&q=60',
                    recipe: [
                        { id: 'inv_1', qty: 1 },
                        { id: 'inv_2', qty: 1 },
                        { id: 'inv_3', qty: 1 },
                        { id: 'inv_5', qty: 0.05 },
                        { id: 'inv_6', qty: 0.02 }
                    ]
                },
                {
                    id: 'p_2',
                    name: 'Papas Fritas',
                    price: 80.00,
                    category: 'sides',
                    image: 'https://images.unsplash.com/photo-1630384060421-a4323ceca0ad?auto=format&fit=crop&w=500&q=60',
                    recipe: [
                        { id: 'inv_4', qty: 0.25 }
                    ]
                },
                {
                    id: 'p_3',
                    name: 'Coca Cola',
                    price: 40.00,
                    category: 'drinks',
                    image: 'https://images.unsplash.com/photo-1622483767028-3f66f32aef97?auto=format&fit=crop&w=500&q=60',
                    recipe: [
                        { id: 'inv_7', qty: 1 }
                    ]
                }
            ],
            sales: [],
            lastTicketNumber: 0,
            settings: {
                storeName: 'Flame & Feast POS',
                storeSubtitle: 'Sistema de Punto de Venta',
                receiptHeader: 'FLAME & FEAST\nFast Food Premium',
                receiptFooter: '¡Gracias por su compra!\nwww.flameandfeast.com'
            }
        };

        class Store {
            constructor() {
                this.state = this.loadLocal(); // Load local first as fallback
                this.cart = [];
                this.currentUser = null;
                this.listeners = [];
                this.isSyncing = false;

                // Initialize Cloud Sync
                this.initCloud();
            }

            async initCloud() {
                // Fetch latest state from Cloud
                const { data, error } = await supabaseClient
                    .from('app_state')
                    .select('data')
                    .eq('id', 1)
                    .single();

                if (data && data.data && Object.keys(data.data).length > 0) {
                    console.log("Cloud Data loaded");
                    this.state = { ...INITIAL_DATA, ...data.data };
                    this.notify();
                } else if (!error) {
                    // If cloud is empty, push local data for the first time
                    console.log("Cloud empty, pushing local data");
                    this.pushToCloud();
                }

                // Subscribe to Realtime changes
                supabaseClient
                    .channel('schema-db-changes')
                    .on('postgres_changes', {
                        event: 'UPDATE',
                        schema: 'public',
                        table: 'app_state',
                        filter: 'id=eq.1'
                    }, payload => {
                        if (!this.isSyncing) {
                            console.log("Remote update received");
                            this.state = { ...this.state, ...payload.new.data };
                            this.notify();
                        }
                    })
                    .subscribe();
            }

            loadLocal() {
                const stored = localStorage.getItem(STORAGE_KEY);
                let state;
                try {
                    state = stored ? JSON.parse(stored) : null;
                } catch (e) {
                    state = null;
                }

                if (!state) {
                    return JSON.parse(JSON.stringify(INITIAL_DATA));
                }

                // Merge top-level objects to ensure new fields (like lastTicketNumber) exist
                state = { ...INITIAL_DATA, ...state };

                // Merge users by ID to ensure Master user exists even if localStorage has old data
                if (INITIAL_DATA.users && state.users) {
                    INITIAL_DATA.users.forEach(initialUser => {
                        const exists = state.users.find(u => u.id === initialUser.id);
                        if (!exists) {
                            state.users.push(JSON.parse(JSON.stringify(initialUser)));
                        }
                    });
                }

                return state;
            }

            save() {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(this.state));
                this.updateDocumentTitle();
                this.pushToCloud();
                this.notify();
            }

            async pushToCloud() {
                this.isSyncing = true;
                const { error } = await supabaseClient
                    .from('app_state')
                    .update({ data: this.state })
                    .eq('id', 1);

                if (error) console.error("Cloud Save Error:", error);

                // Release lock after a short delay to avoid echo
                setTimeout(() => { this.isSyncing = false; }, 1000);
            }

            updateDocumentTitle() {
                if (this.state.settings && this.state.settings.storeName) {
                    document.title = this.state.settings.storeName;
                }
            }

            reset() {
                this.state = JSON.parse(JSON.stringify(INITIAL_DATA));
                this.save();
            }

            login(pin) {
                const user = this.state.users.find(u => u.pin === pin);
                if (user) {
                    this.currentUser = user;
                    this.notify();
                    return true;
                }
                return false;
            }

            logout() {
                this.currentUser = null;
                this.cart = [];
                this.notify();
            }

            addToCart(product, notes = '', qty = 1) {
                const requestedQty = parseInt(qty) || 1;
                const maxStock = this.calculateMaxStock(product);

                // Calculate current total quantity of this product in cart
                const currentQtyInCart = this.cart.reduce((sum, item) =>
                    item.product.id === product.id ? sum + item.qty : sum, 0);

                if (currentQtyInCart + requestedQty > maxStock) {
                    alert('¡No hay suficiente stock para agregar esta cantidad!');
                    return false;
                }

                // Check if exact item (same product + same notes) exists
                const existingItem = this.cart.find(item =>
                    item.product.id === product.id && item.notes === notes
                );

                if (existingItem) {
                    existingItem.qty += requestedQty;
                } else {
                    this.cart.push({
                        id: Date.now() + Math.random(),
                        product: product,
                        notes: notes,
                        qty: requestedQty
                    });
                }

                this.notify();
                return true;
            }

            removeFromCart(cartItemId) {
                this.cart = this.cart.filter(item => item.id !== cartItemId);
                this.notify();
            }

            decreaseCartItem(cartItemId) {
                const item = this.cart.find(i => i.id === cartItemId);
                if (item) {
                    if (item.qty > 1) {
                        item.qty--;
                    } else {
                        // Remove if qty is 1
                        this.cart = this.cart.filter(i => i.id !== cartItemId);
                    }
                    this.notify();
                }
            }

            clearCart() {
                this.cart = [];
                this.notify();
            }

            getCartTotal() {
                return this.cart.reduce((total, item) => total + (item.product.price * item.qty), 0);
            }

            calculateMaxStock(product) {
                let min = Infinity;
                if (!product.recipe || product.recipe.length === 0) return 9999;

                product.recipe.forEach(ing => {
                    const inventoryItem = this.state.inventory.find(inv => inv.id === ing.id);
                    if (!inventoryItem) return;

                    const possible = Math.floor(inventoryItem.quantity / ing.qty);
                    if (possible < min) min = possible;
                });
                return min;
            }

            checkout() {
                if (this.cart.length === 0) return false;

                this.state.lastTicketNumber = (this.state.lastTicketNumber || 0) + 1;
                const sale = {
                    id: Date.now(),
                    ticketNumber: this.state.lastTicketNumber,
                    date: new Date().toISOString(),
                    employee: this.currentUser.name,
                    total: this.getCartTotal(),
                    items: JSON.parse(JSON.stringify(this.cart)), // Deep copy with qty
                    status: 'Abierta'
                };

                this.cart.forEach(item => {
                    if (item.product.recipe) {
                        item.product.recipe.forEach(ing => {
                            const inventoryItem = this.state.inventory.find(inv => inv.id === ing.id);
                            if (inventoryItem) {
                                // Deduct: ingredient qty * item qty
                                const totalDeduction = ing.qty * item.qty;
                                inventoryItem.quantity = Number((inventoryItem.quantity - totalDeduction).toFixed(3));
                            }
                        });
                    }
                });

                this.state.sales.push(sale);
                this.save();
                this.clearCart();
                return sale;
            }

            updateSaleStatus(saleId, newStatus) {
                const sale = this.state.sales.find(s => s.id == saleId);
                if (sale) {
                    const statusHierarchy = { 'Abierta': 1, 'En Proceso': 2, 'Entregada': 3 };
                    const currentRank = statusHierarchy[sale.status] || 0;
                    const newRank = statusHierarchy[newStatus] || 0;

                    if (newRank > currentRank) {
                        sale.status = newStatus;
                        this.save();
                        return true;
                    }
                }
                return false;
            }

            // New method for manual inventory adjustment
            adjustInventory(id, newQuantity, note, user) {
                const item = this.state.inventory.find(i => i.id === id);
                if (item) {
                    const oldQuantity = item.quantity;
                    const diff = newQuantity - oldQuantity;

                    if (!this.state.inventory_movements) this.state.inventory_movements = [];

                    this.state.inventory_movements.push({
                        id: Date.now(),
                        itemId: id,
                        itemName: item.name,
                        oldQty: oldQuantity,
                        newQty: newQuantity,
                        diff: diff,
                        note: `Ajuste Manual: ${note}`,
                        user: user.name,
                        date: new Date().toISOString()
                    });

                    item.quantity = Number(newQuantity);
                    this.save();
                    return true;
                }
                return false;
            }

            updateSettings(newSettings) {
                this.state.settings = { ...this.state.settings, ...newSettings };
                this.save();
            }

            restockInventory(id, qtyToAdd, user) {
                const item = this.state.inventory.find(i => i.id === id);
                if (item) {
                    const oldQuantity = item.quantity;
                    const newQuantity = Number(oldQuantity) + Number(qtyToAdd);

                    if (!this.state.inventory_movements) this.state.inventory_movements = [];

                    this.state.inventory_movements.push({
                        id: Date.now(),
                        itemId: id,
                        itemName: item.name,
                        oldQty: oldQuantity,
                        newQty: newQuantity,
                        diff: qtyToAdd,
                        note: "Reposición de Inventario",
                        user: user.name,
                        date: new Date().toISOString()
                    });

                    item.quantity = newQuantity;
                    this.save();
                    return true;
                }
                return false;
            }

            async fetchBCVRate() {
                const timeout = 8000; // 8 seconds timeout
                const fetchWithTimeout = async (url) => {
                    const controller = new AbortController();
                    const id = setTimeout(() => controller.abort(), timeout);
                    try {
                        const response = await fetch(url, { signal: controller.signal });
                        clearTimeout(id);
                        return response;
                    } catch (e) {
                        clearTimeout(id);
                        throw e;
                    }
                };

                console.log("Iniciando actualización de tasa BCV...");

                // Strategy 1: DolarAPI (Fastest and usually reliable)
                try {
                    const response = await fetchWithTimeout('https://ve.dolarapi.com/v1/dolares/oficial');
                    if (response.ok) {
                        const data = await response.json();
                        if (data && (data.promedio || data.price)) {
                            const val = data.promedio || data.price;
                            console.log("Tasa obtenida via DolarAPI:", val);
                            return this.updateRate(parseFloat(val));
                        }
                    }
                } catch (e) {
                    console.warn("DolarAPI falló, intentando siguiente...");
                }

                // Strategy 2: PyDolar (Alternative API)
                try {
                    const response = await fetchWithTimeout('https://pydolarvenezuela-api.vercel.app/api/v1/dollar?page=bcv');
                    if (response.ok) {
                        const data = await response.json();
                        if (data && data.monitors && data.monitors.usd) {
                            const val = data.monitors.usd.price;
                            console.log("Tasa obtenida via PyDolar:", val);
                            return this.updateRate(parseFloat(val));
                        }
                    }
                } catch (e) {
                    console.warn("PyDolar falló, intentando scrape...");
                }

                // Strategy 3: Scraping via AllOrigins Proxy (Last resort)
                try {
                    const targetUrl = 'https://www.bcv.org.ve/';
                    const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(targetUrl)}&timestamp=${Date.now()}`;
                    const response = await fetchWithTimeout(proxyUrl);
                    if (response.ok) {
                        const data = await response.json();
                        const html = data.contents;
                        const usdMatch = html.match(/id="dolar"[^>]*>[\s\S]*?<strong>\s*([\d,.]+)\s*<\/strong>/i);
                        if (usdMatch && usdMatch[1]) {
                            const rate = parseFloat(usdMatch[1].replace(',', '.'));
                            if (!isNaN(rate) && rate > 0) {
                                console.log("Tasa obtenida via Scraping BCV:", rate);
                                return this.updateRate(rate);
                            }
                        }
                    }
                } catch (e) {
                    console.error("Todas las fuentes de tasa BCV fallaron:", e);
                }

                // If everything failed and we have no rate, at least stop the loading state
                if (!this.state.bcvRate || this.state.bcvRate.rate <= 0) {
                    this.state.bcvRate = { rate: -1, lastUpdated: new Date().toISOString() };
                    this.notify();
                }
                return null;
            }

            updateRate(rate, isManual = false) {
                if (rate > 0) {
                    this.state.bcvRate = {
                        rate: Number(rate),
                        lastUpdated: new Date().toISOString(),
                        isManual: isManual
                    };
                    this.save();
                    return true;
                }
                return false;
            }

            addInventoryItem(item) {
                this.state.inventory.push(item);
                this.save();
            }

            deleteInventoryItem(id) {
                // Check usage in recipes
                const isUsed = this.state.products.some(p => p.recipe && p.recipe.some(r => r.id === id));
                if (isUsed) {
                    alert('No se puede eliminar este ingrediente porque está siendo usado en la receta de un producto.');
                    return false;
                }

                this.state.inventory = this.state.inventory.filter(i => i.id !== id);
                this.save();
                return true;
            }

            addProduct(product) {
                this.state.products.push(product);
                this.save();
            }

            updateProduct(product) {
                const index = this.state.products.findIndex(p => p.id === product.id);
                if (index !== -1) {
                    this.state.products[index] = product;
                    this.save();
                }
            }

            deleteProduct(id) {
                this.state.products = this.state.products.filter(p => p.id !== id);
                this.save();
            }

            addCategory(category) {
                this.state.categories.push(category);
                this.save();
            }

            deleteCategory(id) {
                // Check if used
                const isUsed = this.state.products.some(p => p.category === id);
                if (isUsed) {
                    alert('No se puede eliminar esta categoría porque hay productos que la usan.');
                    return false;
                }
                this.state.categories = this.state.categories.filter(c => c.id !== id);
                this.save();
                return true;
            }

            closeSession() {
                this.state.sales = [];
                this.state.lastTicketNumber = 0;
                this.save();
            }

            updateUserPin(userId, newPin) {
                const user = this.state.users.find(u => u.id === userId);
                if (user) {
                    user.pin = newPin;
                    this.save();
                    return true;
                }
                return false;
            }

            subscribe(listener) {
                this.listeners.push(listener);
                listener(this);
            }

            notify() {
                this.listeners.forEach(listener => listener(this));
            }
        }

        window.store = new Store();
    </script>

    <!-- 2. VIEWS -->
    <script>
        window.views = {
            renderLogin() {
                const store = window.store;
                return `
                    <div class="flex flex-col items-center justify-center w-full h-full bg-gray-950 pattern-grid">
                        <div class="glass-panel p-8 rounded-2xl flex flex-col items-center w-96 max-w-full m-4">
                            <div class="w-16 h-16 bg-orange-600 rounded-full flex items-center justify-center mb-6 shadow-lg shadow-orange-900/50">
                                <i data-lucide="flame" class="w-8 h-8 text-white"></i>
                            </div>
                            <h1 class="text-3xl font-bold mb-2">${store.state.settings.storeName || 'Flame & Feast'}</h1>
                            <p class="text-gray-400 mb-8">${store.state.settings.storeSubtitle || 'Sistema de Punto de Venta'}</p>
                            
                            <div class="w-full space-y-4">
                                <h3 class="text-sm font-semibold text-gray-500 uppercase tracking-widest mb-2">Seleccionar Usuario</h3>
                                <div class="grid gap-3">
                                    ${store.state.users.map(u => `
                                        <button onclick="window.posApp.requestPin('${u.pin}', '${u.name}')" 
                                            class="user-btn bg-gray-800 hover:bg-gray-700 p-4 rounded-xl flex items-center gap-4 transition-all w-full text-left group">
                                            <div class="w-10 h-10 rounded-full bg-gray-700 group-hover:bg-orange-600 text-white flex items-center justify-center font-bold transition-colors">
                                                ${u.name.charAt(0)}
                                            </div>
                                            <span class="font-medium text-lg">${u.name}</span>
                                        </button>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            },

            renderPOS() {
                const store = window.store;
                const products = store.state.products;
                const cart = store.cart;
                const posMobileView = window.posApp.posMobileView;

                return `
                    <div class="flex flex-col md:flex-row w-full h-full overflow-hidden relative">
                        <!-- Mobile View Toggle FAB -->
                        <button onclick="window.posApp.toggleMobilePOS()" 
                            class="md:hidden fixed bottom-20 right-6 z-[60] w-16 h-16 bg-orange-600 text-white rounded-full shadow-2xl shadow-orange-900/40 flex items-center justify-center active:scale-90 transition-all border-4 border-gray-950">
                            <div class="relative">
                                <i data-lucide="${posMobileView === 'menu' ? 'shopping-cart' : 'layout-grid'}" class="w-7 h-7"></i>
                                ${cart.length > 0 ? `
                                    <span class="absolute -top-3 -right-3 bg-white text-orange-600 text-[10px] font-black w-5 h-5 rounded-full flex items-center justify-center border-2 border-orange-600 animate-in zoom-in">
                                        ${cart.reduce((a, b) => a + b.qty, 0)}
                                    </span>
                                ` : ''}
                            </div>
                        </button>

                        <!-- Cart Panel -->
                        <section class="${posMobileView === 'cart' ? 'flex' : 'hidden'} md:flex min-w-[320px] md:w-1/3 lg:w-1/4 h-full p-2 md:p-4 flex flex-col z-10 transition-all duration-300">
                            <div class="glass-panel rounded-3xl h-full flex flex-col p-4 md:p-5 relative overflow-hidden">
                                <div class="flex items-center justify-between mb-4 md:mb-6">
                                    <div class="flex items-center gap-2 md:gap-3">
                                     <div class="w-10 h-10 rounded-full bg-orange-600/20 flex items-center justify-center text-orange-500">
                                        <i data-lucide="shopping-cart" class="w-5 h-5"></i>
                                     </div>
                                      <div>
                                        <h2 class="text-lg font-bold leading-none">Orden Actual</h2>
                                        <span class="text-xs text-gray-400">Ticket #${(store.state.lastTicketNumber || 0) + 1}</span>
                                      </div>
                                </div>
                                <button onclick="window.posApp.clearCart()" class="p-2 rounded-lg bg-gray-800 hover:bg-red-500/20 hover:text-red-500 text-gray-400 transition-colors" title="Limpiar Carrito">
                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                </button>
                            </div>

                            <div class="flex-1 overflow-y-auto space-y-3 pr-1 custom-scrollbar">
                                ${cart.length === 0 ? `
                                    <div class="h-full flex flex-col items-center justify-center text-gray-500 opacity-50 space-y-4">
                                        <i data-lucide="shopping-bag" class="w-20 h-20 stroke-1"></i>
                                        <p class="text-sm">Selecciona productos del menú</p>
                                    </div>
                                ` : cart.map(item => `
                                    <div class="relative flex items-start gap-3 p-3 rounded-xl bg-gray-800/40 border border-gray-700/50 hover:bg-gray-800/60 transition-colors group animate-fade-in-right">
                                        <div class="relative">
                                            <img src="${item.product.image}" class="w-16 h-16 rounded-lg object-cover bg-gray-800" />
                                            <div class="absolute -top-2 -left-2 bg-orange-600 text-white text-xs font-bold w-6 h-6 rounded-full flex items-center justify-center shadow-lg border border-gray-900">
                                                ${item.qty}
                                            </div>
                                        </div>
                                        <div class="flex-1 min-w-0 py-1">
                                            <div class="flex justify-between items-start">
                                                <h4 class="font-bold text-gray-200 truncate pr-2">${item.product.name}</h4>
                                                <span class="font-bold text-orange-400">$${(item.product.price * item.qty).toFixed(2)}</span>
                                            </div>
                                            ${item.notes ? `
                                                <div class="mt-1 flex items-start gap-1">
                                                    <i data-lucide="file-edit" class="w-3 h-3 text-gray-500 mt-0.5"></i>
                                                    <p class="text-xs text-gray-400 italic leading-snug">"${item.notes}"</p>
                                                </div>
                                            ` : ''}
                                            <div class="absolute -top-2 -right-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                                <button onclick="window.posApp.removeFromCart(${item.id})" class="bg-red-500 text-white rounded-full p-1 shadow-lg hover:scale-110 transition-transform" title="Quitar 1 unidad">
                                                    <i data-lucide="minus" class="w-3 h-3"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>

                            <div class="mt-4 pt-4 border-t border-white/5 bg-gray-900/30 -mx-5 px-5 pb-0">
                               <div class="flex justify-between items-end mb-4">
                                    <span class="text-gray-400 text-sm font-medium uppercase tracking-wider">Total a Pagar</span>
                                    <span class="text-4xl font-bold text-white tracking-tight">$${store.getCartTotal().toFixed(2)}</span>
                               </div>
                               
                               <button onclick="window.posApp.checkout()" 
                                    class="w-full py-4 rounded-xl bg-gradient-to-r from-orange-600 to-orange-500 hover:from-orange-500 hover:to-orange-400 text-white font-bold text-lg shadow-lg shadow-orange-900/50 transition-all transform active:scale-95 flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
                                    ${cart.length === 0 ? 'disabled' : ''}>
                                    <i data-lucide="credit-card" class="w-5 h-5"></i>
                                    <span>COBRAR E IMPRIMIR</span>
                               </button>
                            </div>
                        </div>
                    </section>

                    <!-- Product Grid -->
                    <section class="${posMobileView === 'menu' ? 'flex' : 'hidden'} md:flex flex-1 h-full p-2 md:p-4 md:pl-0 overflow-y-auto custom-scrollbar flex-col">
                        <div class="sticky top-0 z-20 bg-gray-950/90 backdrop-blur-sm pb-3 md:pb-4 pt-1 md:pt-2 mb-3 md:mb-4 border-b border-gray-800 flex items-center justify-between">
                            <div>
                                 <h2 class="text-xl md:text-2xl font-bold text-white">Menú</h2>
                                 <p class="text-gray-400 text-[10px] md:text-sm">Selecciona productos</p>
                            </div>
                            <div class="flex gap-2 overflow-x-auto no-scrollbar max-w-[50%]">
                                <div class="bg-gray-800 rounded-lg p-1 flex">
                                    <button onclick="window.posApp.filterCategory('all')" 
                                        class="px-3 md:px-4 py-1.5 rounded-md text-[10px] md:text-sm font-medium transition-colors ${window.posApp.activeCategory === 'all' ? 'bg-orange-600 text-white shadow' : 'text-gray-400 hover:text-white'}">
                                        Todos
                                    </button>
                                    ${store.state.categories ? store.state.categories.map(c => `
                                        <button onclick="window.posApp.filterCategory('${c.id}')" 
                                            class="px-3 md:px-4 py-1.5 rounded-md text-[10px] md:text-sm font-medium transition-colors whitespace-nowrap ${window.posApp.activeCategory === c.id ? 'bg-orange-600 text-white shadow' : 'text-gray-400 hover:text-white'}">
                                            ${c.name}
                                        </button>
                                    `).join('') : ''}
                                </div>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3 md:gap-4 pb-20">
                            ${products
                        .filter(p => window.posApp.activeCategory === 'all' || p.category === window.posApp.activeCategory)
                        .map(p => {
                            const maxStock = store.calculateMaxStock(p);
                            const isOutOfStock = maxStock <= 0;
                            const isLowStock = maxStock < 5 && maxStock > 0;

                            return `
                                <div onclick="${!isOutOfStock ? `window.posApp.openProductModal('${p.id}')` : ''}" 
                                     class="card bg-gray-900/60 border border-gray-800 hover:border-orange-500/50 rounded-2xl p-3 flex flex-col gap-3 transition-all group relative overflow-hidden cursor-pointer ${isOutOfStock ? 'opacity-50 grayscale pointer-events-none' : ''}">
                                    
                                    <div class="aspect-[4/3] rounded-xl overflow-hidden relative shadow-inner">
                                        <img src="${p.image}" class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500" loading="lazy">
                                        ${isOutOfStock ? `
                                            <div class="absolute inset-0 bg-black/70 flex items-center justify-center backdrop-blur-sm">
                                                <span class="px-3 py-1 bg-red-600 text-white text-xs font-bold rounded-full shadow-lg">AGOTADO</span>
                                            </div>
                                        ` : ''}
                                        ${isLowStock ? `
                                            <div class="absolute top-2 right-2">
                                                <span class="px-2 py-0.5 bg-orange-500 text-white text-[10px] font-bold rounded-full shadow-lg animate-pulse">POCAS UNIDADES</span>
                                            </div>
                                        ` : ''}
                                    </div>
                                    
                                    <div class="flex-1 flex flex-col">
                                        <h3 class="font-bold text-gray-100 text-lg leading-tight mb-1 group-hover:text-orange-400 transition-colors">${p.name}</h3>
                                        
                                        <!-- Mini Ingredient List -->
                                        <div class="flex flex-wrap gap-1 mb-3">
                                            ${(p.recipe || []).map(r => {
                                const inv = store.state.inventory.find(i => i.id === r.id);
                                return `<span class="text-[9px] px-1.5 py-0.5 bg-gray-800 text-gray-400 rounded-md border border-gray-700/50">${inv ? inv.name : r.id}</span>`;
                            }).join('')}
                                        </div>
                                        
                                        <div class="mt-auto flex justify-between items-center">
                                            <span class="text-xl font-bold text-white">$${p.price}</span>
                                            <div class="w-8 h-8 rounded-full bg-gray-800 group-hover:bg-orange-600 flex items-center justify-center text-white transition-colors shadow">
                                                <i data-lucide="plus" class="w-5 h-5"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `}).join('')}
                        </div>
                    </section>
                    
                    <!-- Mobile View Toggle Button -->
                    <button onclick="window.posApp.setPosMobileView('${posMobileView === 'menu' ? 'cart' : 'menu'}')"
                        class="md:hidden fixed bottom-20 right-4 w-14 h-14 bg-orange-600 text-white rounded-full shadow-2xl flex items-center justify-center z-40 animate-bounce-subtle">
                        <i data-lucide="${posMobileView === 'menu' ? 'shopping-cart' : 'arrow-left'}" class="w-6 h-6"></i>
                        ${posMobileView === 'menu' && cart.length > 0 ? `
                            <span class="absolute -top-1 -right-1 bg-white text-orange-600 text-[10px] font-bold w-5 h-5 rounded-full flex items-center justify-center border-2 border-orange-600">
                                ${cart.length}
                            </span>
                        ` : ''}
                    </button>
                </div>
                `;
            },

            renderAdmin() {
                try {
                    const store = window.store;
                    const activeTab = window.posApp.adminTab || 'dashboard';
                    const isManager = store.currentUser && (store.currentUser.id === 2 || store.currentUser.id === 3);
                    const isMaster = store.currentUser && store.currentUser.id === 3;

                    const renderTabs = () => `
                        <div class="flex gap-4 mb-6 border-b border-gray-800 pb-1 overflow-x-auto no-scrollbar shrink-0">
                            <button onclick="window.posApp.setAdminTab('dashboard')" class="${activeTab === 'dashboard' ? 'text-orange-500 border-b-2 border-orange-500' : 'text-gray-400 hover:text-white'} pb-3 px-2 font-medium transition-colors whitespace-nowrap">Dashboard</button>
                            <button onclick="window.posApp.setAdminTab('inventory')" class="${activeTab === 'inventory' ? 'text-orange-500 border-b-2 border-orange-500' : 'text-gray-400 hover:text-white'} pb-3 px-2 font-medium transition-colors whitespace-nowrap">Inventario</button>
                            ${isManager ? `
                                <button onclick="window.posApp.setAdminTab('products')" class="${activeTab === 'products' ? 'text-orange-500 border-b-2 border-orange-500' : 'text-gray-400 hover:text-white'} pb-3 px-2 font-medium transition-colors whitespace-nowrap">Productos</button>
                                <button onclick="window.posApp.setAdminTab('categories')" class="${activeTab === 'categories' ? 'text-orange-500 border-b-2 border-orange-500' : 'text-gray-400 hover:text-white'} pb-3 px-2 font-medium transition-colors whitespace-nowrap">Categorías</button>
                            ` : ''}
                             ${isMaster ? `
                                <button onclick="window.posApp.setAdminTab('users')" class="${activeTab === 'users' ? 'text-orange-500 border-b-2 border-orange-500' : 'text-gray-400 hover:text-white'} pb-3 px-2 font-medium transition-colors whitespace-nowrap">Usuarios</button>
                                <button onclick="window.posApp.setAdminTab('settings')" class="${activeTab === 'settings' ? 'text-orange-500 border-b-2 border-orange-500' : 'text-gray-400 hover:text-white'} pb-3 px-2 font-medium transition-colors whitespace-nowrap">Configuración</button>
                            ` : ''}
                        </div>
                    `;

                    return `
                        <div class="flex flex-col w-full h-full overflow-hidden">
                            <header class="h-16 md:h-20 border-b border-gray-800 bg-gray-900/50 backdrop-blur-md flex items-center justify-between px-4 md:px-8 z-20 shrink-0">
                                <div class="flex items-center gap-3">
                                    <h2 class="text-xl md:text-2xl font-bold text-white">Panel Admin</h2>
                                    ${!isManager ? '<span class="hidden sm:inline px-2 py-0.5 bg-gray-800 text-gray-500 text-[10px] rounded-full border border-gray-700">Cajero</span>' : '<span class="hidden sm:inline px-2 py-0.5 bg-orange-600/20 text-orange-500 text-[10px] rounded-full border border-orange-500/30">Gerente</span>'}
                                </div>
                            </header>

                            <div class="flex-1 overflow-y-auto p-4 md:p-8 custom-scrollbar">
                                ${renderTabs()}
                                ${this.renderAdminContent(activeTab)}
                            </div>
                        </div>
                    `;
                } catch (e) {
                    console.error("Render Admin Error:", e);
                    return `<div class="p-10 text-red-500 font-mono text-xl text-center">Error al cargar panel de administración.</div>`;
                }
            },

            renderAdminContent(activeTab) {
                const inventory = store.state.inventory;
                const products = store.state.products;
                const sales = store.state.sales;
                const isManager = store.currentUser && (store.currentUser.id === 2 || store.currentUser.id === 3);
                const isMaster = store.currentUser && store.currentUser.id === 3;

                if (activeTab === 'dashboard') {
                    const totalSales = sales.reduce((sum, s) => sum + (s.total || 0), 0);
                    const todaySales = sales.filter(s => new Date(s.date).toDateString() === new Date().toDateString()).reduce((sum, s) => sum + (s.total || 0), 0);
                    return `
                        <div class="space-y-8">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div class="glass-panel p-4 rounded-2xl flex items-center gap-4">
                                    <div class="p-3 bg-green-500/10 text-green-500 rounded-2xl"><i data-lucide="dollar-sign" class="w-6 h-6"></i></div>
                                    <div><p class="text-gray-500 text-xs font-bold uppercase tracking-wider mb-1">Ventas Hoy</p><h3 class="text-2xl font-bold text-white">$${todaySales.toFixed(2)}</h3></div>
                                </div>
                                <div class="glass-panel p-4 rounded-2xl flex items-center gap-4">
                                    <div class="p-3 bg-blue-500/10 text-blue-500 rounded-2xl"><i data-lucide="shopping-bag" class="w-6 h-6"></i></div>
                                    <div><p class="text-gray-500 text-xs font-bold uppercase tracking-wider mb-1">Transacciones</p><h3 class="text-2xl font-bold text-white">${sales.length}</h3></div>
                                </div>
                                <div class="glass-panel p-4 rounded-2xl flex items-center gap-4">
                                    <div class="p-3 bg-orange-500/10 text-orange-500 rounded-2xl"><i data-lucide="alert-triangle" class="w-6 h-6"></i></div>
                                    <div><p class="text-gray-500 text-xs font-bold uppercase tracking-wider mb-1">Alerta Stock</p><h3 class="text-2xl font-bold text-white">${inventory.filter(i => i.quantity <= i.alert).length}</h3></div>
                                </div>
                            </div>

                            <div class="flex flex-wrap gap-3">
                                <button onclick="window.posApp.handlePrintSessionReport()" class="flex-1 md:flex-none px-6 py-3 bg-blue-600 hover:bg-blue-500 text-white rounded-xl font-bold flex items-center justify-center gap-2 transition-all shadow-lg shadow-blue-900/20">
                                    <i data-lucide="printer" class="w-5 h-5"></i> IMPRIMIR REPORTE
                                </button>
                                <button onclick="window.posApp.handleCloseSession()" class="flex-1 md:flex-none px-6 py-3 bg-red-600/10 text-red-500 hover:bg-red-600 hover:text-white rounded-xl font-bold flex items-center justify-center gap-2 transition-all border border-red-500/20">
                                    <i data-lucide="power" class="w-5 h-5"></i> CERRAR JORNADA
                                </button>
                            </div>

                            <div class="glass-panel rounded-2xl overflow-hidden border border-gray-800">
                                <div class="p-6 border-b border-gray-800 bg-gray-900/30"><h2 class="text-lg font-bold text-white">Ventas Recientes</h2></div>
                                <div class="overflow-x-auto">
                                    <table class="w-full text-left text-sm whitespace-nowrap">
                                        <thead class="bg-gray-900/50 text-gray-500 font-bold uppercase text-[10px] tracking-widest">
                                            <tr>
                                                <th class="px-6 py-4">ID</th>
                                                <th class="px-6 py-4">Hora</th>
                                                <th class="px-6 py-4">Cajero</th>
                                                <th class="px-6 py-4">Total</th>
                                                <th class="px-6 py-4 text-center">Estatus</th>
                                            </tr>
                                        </thead>
                                        <tbody class="divide-y divide-gray-800/50">
                                            ${sales.length === 0 ? '<tr><td colspan="5" class="px-6 py-10 text-center text-gray-500 italic">No hay ventas registradas</td></tr>' :
                            sales.slice().reverse().slice(0, 50).map(s => `
                                                <tr onclick="window.posApp.openSaleDetails('${s.id}')" class="hover:bg-gray-800/50 cursor-pointer transition-colors group">
                                                    <td class="px-6 py-4 font-mono text-gray-400 group-hover:text-orange-500">#${s.ticketNumber || s.id.toString().slice(-6)}</td>
                                                    <td class="px-6 py-4 text-gray-400">${new Date(s.date).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</td>
                                                    <td class="px-6 py-4 text-white">${s.employee}</td>
                                                    <td class="px-6 py-4 font-bold text-white">$${(s.total || 0).toFixed(2)}</td>
                                                    <td class="px-6 py-4 text-center">
                                                        <span class="px-2 py-1 rounded-full text-[10px] font-bold border ${s.status === 'Entregada' ? 'bg-green-500/10 text-green-500 border-green-500/20' :
                                    s.status === 'En Proceso' ? 'bg-blue-500/10 text-blue-500 border-blue-500/20' :
                                        'bg-orange-500/10 text-orange-500 border-orange-500/20'
                                }">${(s.status || 'Abierta').toUpperCase()}</span>
                                                    </td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    `;
                }

                if (activeTab === 'inventory') {
                    const lowStockItems = inventory.filter(i => i.quantity <= i.alert).length;
                    return `
                        <div class="glass-panel rounded-2xl overflow-hidden border border-gray-800">
                            <div class="p-6 border-b border-gray-800 bg-gray-900/30 flex flex-wrap justify-between items-center gap-4">
                                <div>
                                    <h2 class="text-lg font-bold text-white">Gestión de Inventario</h2>
                                    <p class="text-gray-500 text-xs">${inventory.length} ingredientes, ${lowStockItems} alertas</p>
                                </div>
                                ${isManager ? `<button onclick="window.posApp.handleAddInventoryItem()" class="bg-orange-600 hover:bg-orange-500 text-white px-4 py-2 rounded-xl text-sm font-bold flex items-center gap-2 transition-all"><i data-lucide="plus" class="w-4 h-4"></i> Nuevo Item</button>` : ''}
                            </div>
                            <div class="overflow-x-auto overflow-y-auto max-h-[60vh] custom-scrollbar">
                                <table class="w-full text-left text-sm whitespace-nowrap">
                                    <thead class="bg-gray-900/50 text-gray-500 font-bold uppercase text-[10px] tracking-widest sticky top-0 z-10">
                                        <tr>
                                            <th class="px-6 py-4">Ingrediente</th>
                                            <th class="px-6 py-4">Cantidad</th>
                                            <th class="px-6 py-4">Estado</th>
                                            <th class="px-6 py-4 text-right">Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-gray-800/50">
                                        ${inventory.map(item => {
                        const isLow = item.quantity <= item.alert;
                        return `
                                                <tr class="hover:bg-gray-800/20 transition-colors">
                                                    <td class="px-6 py-4">
                                                        <span class="text-white font-bold block">${item.name}</span>
                                                        <span class="text-gray-600 text-[10px] font-mono">${item.id}</span>
                                                    </td>
                                                    <td class="px-6 py-4">
                                                        <span class="font-mono text-base ${isLow ? 'text-red-500 font-bold' : 'text-gray-300'}">${item.quantity}</span>
                                                        <span class="text-gray-600 text-xs ml-1">${item.unit}</span>
                                                    </td>
                                                    <td class="px-6 py-4">
                                                        ${isLow ? '<span class="px-2 py-0.5 rounded-full text-[10px] font-bold bg-red-500/10 text-red-500 border border-red-500/20">BAJO STOCK</span>' : '<span class="px-2 py-0.5 rounded-full text-[10px] font-bold bg-green-500/10 text-green-500 border border-green-500/20">OK</span>'}
                                                    </td>
                                                    <td class="px-6 py-4 text-right">
                                                        <div class="flex justify-end gap-2">
                                                            <button onclick="window.posApp.openRestockModal('${item.id}')" class="p-2 text-green-500 hover:bg-green-500/10 rounded-lg transition-colors border border-green-500/20" title="Reponer"><i data-lucide="plus" class="w-4 h-4"></i></button>
                                                            ${isManager ? `
                                                                <button onclick="window.posApp.openAdjustmentModal('${item.id}')" class="p-2 text-orange-500 hover:bg-orange-500/10 rounded-lg transition-colors border border-orange-500/20" title="Ajustar"><i data-lucide="settings-2" class="w-4 h-4"></i></button>
                                                                <button onclick="window.posApp.handleDeleteInventoryItem('${item.id}')" class="p-2 text-red-500 hover:bg-red-500/10 rounded-lg transition-colors border border-red-500/20" title="Eliminar"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                                            ` : ''}
                                                        </div>
                                                    </td>
                                                </tr>
                                            `;
                    }).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `;
                }

                if (activeTab === 'products') {
                    if (!isManager) return '<div class="p-10 text-center text-red-500">Acceso restringido.</div>';
                    return `
                        <div class="space-y-6">
                            <div class="flex justify-between items-center bg-gray-900/30 p-4 rounded-2xl border border-gray-800">
                                <h2 class="text-lg font-bold text-white">Mis Productos</h2>
                                <button onclick="window.posApp.openProductEditor()" class="bg-orange-600 hover:bg-orange-500 text-white px-4 py-2 rounded-xl text-sm font-bold flex items-center gap-2 shadow-lg shadow-orange-900/20 transition-all"><i data-lucide="plus" class="w-4 h-4"></i> Agregar</button>
                            </div>
                            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 pb-20">
                                ${products.map(p => `
                                    <div class="glass-panel p-4 rounded-2xl flex flex-col gap-3 group relative border border-gray-800 hover:border-orange-500/30 transition-all">
                                        <div class="h-32 rounded-xl overflow-hidden relative">
                                            <img src="${p.image}" class="w-full h-full object-cover">
                                            <div class="absolute top-2 right-2 flex gap-1 opacity-0 group-hover:opacity-100 transition-all scale-90 group-hover:scale-100">
                                                <button onclick="window.posApp.openProductEditor('${p.id}')" class="p-2 bg-gray-900/80 backdrop-blur-md rounded-lg text-white hover:bg-orange-600 transition-all"><i data-lucide="edit-2" class="w-4 h-4"></i></button>
                                                <button onclick="window.posApp.deleteProduct('${p.id}')" class="p-2 bg-red-600/80 backdrop-blur-md rounded-lg text-white hover:bg-red-700 transition-all"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                            </div>
                                        </div>
                                        <div>
                                            <h3 class="font-bold text-white text-base truncate">${p.name}</h3>
                                            <div class="flex justify-between items-center mt-1">
                                                <span class="text-orange-500 font-bold text-lg">$${p.price}</span>
                                                <span class="text-gray-600 text-[10px] font-bold uppercase bg-gray-800 px-2 py-0.5 rounded">${p.category}</span>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }

                if (activeTab === 'categories') {
                    if (!isManager) return '<div class="p-10 text-center text-red-500">Acceso restringido.</div>';
                    return `
                        <div class="max-w-xl mx-auto space-y-6">
                            <div class="glass-panel rounded-2xl overflow-hidden border border-gray-800">
                                <div class="p-6 border-b border-gray-800 bg-gray-900/30 flex justify-between items-center">
                                    <h2 class="text-xl font-bold text-white">Categorías</h2>
                                    <button onclick="window.posApp.handleAddCategory()" class="bg-orange-600 hover:bg-orange-500 text-white px-4 py-2 rounded-xl font-bold text-sm shadow-lg shadow-orange-900/20 transition-all">Nueva</button>
                                </div>
                                <div class="p-6 space-y-3">
                                    ${(store.state.categories || []).map(cat => `
                                        <div class="flex items-center justify-between bg-gray-900/50 p-4 rounded-xl border border-gray-800 group hover:border-gray-700 transition-all">
                                            <span class="text-white font-bold">${cat.name}</span>
                                            <button onclick="window.posApp.handleDeleteCategory('${cat.id}')" class="p-2 text-gray-500 hover:text-red-500 hover:bg-red-500/10 rounded-lg transition-all"><i data-lucide="trash-2" class="w-5 h-5"></i></button>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    `;
                }

                if (activeTab === 'users') {
                    if (!isMaster) return '<div class="p-10 text-center text-red-500">Solo el Usuario Master puede acceder aquí.</div>';
                    return `
                        <div class="max-w-xl mx-auto space-y-6">
                            <div class="glass-panel rounded-2xl overflow-hidden border border-gray-800">
                                <div class="p-6 border-b border-gray-800 bg-gray-900/30">
                                    <h2 class="text-xl font-bold text-white uppercase tracking-wider">Gestión de Accesos</h2>
                                    <p class="text-gray-500 text-xs">Administración de PINs de usuarios registrados.</p>
                                </div>
                                <div class="p-6 space-y-4">
                                    ${store.state.users.map(u => `
                                        <div class="flex items-center justify-between bg-gray-900/50 p-5 rounded-xl border border-gray-800 hover:border-orange-500/30 transition-all">
                                            <div class="flex items-center gap-4">
                                                <div class="w-10 h-10 rounded-full bg-gray-800 flex items-center justify-center text-gray-400"><i data-lucide="user" class="w-5 h-5"></i></div>
                                                <div>
                                                    <span class="text-white font-bold block text-lg">${u.name}</span>
                                                    <span class="text-gray-500 text-[10px] font-mono">${u.id === 3 ? 'MASTER' : (u.id === 2 ? 'GERENTE' : 'CAJERO')}</span>
                                                </div>
                                            </div>
                                            <button onclick="window.posApp.handleUpdatePin(${u.id})" class="px-4 py-2 bg-gray-800 hover:bg-orange-600 text-white rounded-lg text-xs font-bold transition-all border border-gray-700">CAMBIAR PIN</button>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    `;
                }

                if (activeTab === 'settings') {
                    if (!isMaster) return '<div class="p-10 text-center text-red-500">Solo el Usuario Master puede acceder aquí.</div>';
                    const settings = store.state.settings || {};
                    return `
                        <div class="max-w-2xl mx-auto space-y-8">
                            <div class="glass-panel rounded-3xl overflow-hidden border border-gray-800 shadow-2xl">
                                <div class="p-8 border-b border-gray-800 bg-gray-900/30">
                                    <h2 class="text-2xl font-black text-white uppercase tracking-tight flex items-center gap-3">
                                        <i data-lucide="settings" class="w-6 h-6 text-orange-500"></i> Configuración de Factura
                                    </h2>
                                    <p class="text-gray-500 text-sm mt-1">Personaliza el encabezado y pie de página de tus tickets impresos.</p>
                                </div>
                                
                                <form onsubmit="window.posApp.handleUpdateSettings(event)" class="p-8 space-y-8">
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                        <div class="space-y-3">
                                            <label class="block text-xs font-black text-gray-500 uppercase tracking-widest ml-1">Nombre del Negocio (Pestaña)</label>
                                            <input type="text" name="storeName" value="${settings.storeName || ''}" 
                                                class="w-full bg-gray-950 border border-gray-800 rounded-2xl p-5 text-white font-bold text-sm focus:border-orange-500 outline-none transition-all">
                                        </div>
                                        <div class="space-y-3">
                                            <label class="block text-xs font-black text-gray-500 uppercase tracking-widest ml-1">Subtítulo (Pantalla Login)</label>
                                            <input type="text" name="storeSubtitle" value="${settings.storeSubtitle || ''}" 
                                                class="w-full bg-gray-950 border border-gray-800 rounded-2xl p-5 text-white font-bold text-sm focus:border-orange-500 outline-none transition-all">
                                        </div>
                                    </div>

                                    <div class="space-y-3">
                                        <label class="block text-xs font-black text-gray-500 uppercase tracking-widest ml-1">Encabezado del Ticket</label>
                                        <textarea name="receiptHeader" rows="4" 
                                            class="w-full bg-gray-950 border border-gray-800 rounded-2xl p-5 text-white font-mono text-sm focus:border-orange-500 outline-none resize-none transition-all"
                                            placeholder="Nombre del Negocio\nDirección\nRIF/NIT">${settings.receiptHeader || ''}</textarea>
                                        <p class="text-[10px] text-gray-600 italic px-1">Tip: Usa saltos de línea para separar la información.</p>
                                    </div>

                                    <div class="space-y-3">
                                        <label class="block text-xs font-black text-gray-500 uppercase tracking-widest ml-1">Pie de Página del Ticket</label>
                                        <textarea name="receiptFooter" rows="3" 
                                            class="w-full bg-gray-950 border border-gray-800 rounded-2xl p-5 text-white font-mono text-sm focus:border-orange-500 outline-none resize-none transition-all"
                                            placeholder="¡Gracias por preferirnos!\n¡Vuelva pronto!">${settings.receiptFooter || ''}</textarea>
                                    </div>

                                    <div class="pt-4">
                                        <button type="submit" 
                                            class="w-full bg-orange-600 hover:bg-orange-500 text-white py-5 rounded-2xl font-black text-lg shadow-xl shadow-orange-900/40 active:scale-[0.98] transition-all flex items-center justify-center gap-3">
                                            <i data-lucide="save" class="w-6 h-6"></i> GUARDAR CONFIGURACIÓN
                                        </button>
                                    </div>
                                </form>
                            </div>

                            <div class="glass-panel p-6 rounded-2xl border border-blue-500/20 bg-blue-500/5 flex gap-4 items-start">
                                <i data-lucide="info" class="w-6 h-6 text-blue-500 shrink-0 mt-1"></i>
                                <div>
                                    <h4 class="text-blue-500 font-bold mb-1">Nota de Impresión</h4>
                                    <p class="text-gray-400 text-xs leading-relaxed">Estos cambios afectarán a todos los tickets impresos a partir de ahora, tanto en el POS como en los reportes del sistema.</p>
                                </div>
                            </div>
                        </div>
                    `;
                }

                return '<div class="p-10 text-white text-center">Pestaña no encontrada.</div>';
            },

            renderProductEditorModal(product = null) {
                const isEdit = !!product;
                const p = product || { id: '', name: '', price: '', image: '', category: 'burgers' };
                const isManager = store.currentUser && (store.currentUser.id === 2 || store.currentUser.id === 3);

                return `
                    <div class="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4" id="editor-modal">
                        <div class="glass-panel w-full max-w-lg rounded-2xl p-6 shadow-2xl animate-in zoom-in-95 max-h-[90vh] overflow-y-auto custom-scrollbar">
                            <h2 class="text-2xl font-bold text-white mb-6">${isEdit ? 'Editar Producto' : 'Nuevo Producto'}</h2>

                            <form onsubmit="window.posApp.saveProduct(event, '${p.id}')" class="space-y-4">
                                <div>
                                    <label class="block text-sm text-gray-400 mb-1">Nombre</label>
                                    <input type="text" name="name" value="${p.name}" required class="w-full bg-gray-900 border border-gray-700 rounded-lg p-3 text-white focus:border-orange-500 outline-none">
                                </div>
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm text-gray-400 mb-1">Precio</label>
                                        <input type="number" step="0.01" name="price" value="${p.price}" required class="w-full bg-gray-900 border border-gray-700 rounded-lg p-3 text-white focus:border-orange-500 outline-none">
                                    </div>
                                    <div>
                                        <label class="block text-sm text-gray-400 mb-1">Categoría</label>
                                        <select name="category" class="w-full bg-gray-900 border border-gray-700 rounded-lg p-3 text-white focus:border-orange-500 outline-none">
                                            ${(store.state.categories || []).map(cat => `
                                                <option value="${cat.id}" ${p.category === cat.id ? 'selected' : ''}>${cat.name}</option>
                                            `).join('')}
                                        </select>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm text-gray-400 mb-1">Imagen URL</label>
                                    <div class="flex gap-2">
                                        <input type="url" name="image" id="img-url-input" value="${p.image}" placeholder="https://..." class="flex-1 bg-gray-900 border border-gray-700 rounded-lg p-3 text-white text-sm focus:border-orange-500 outline-none">
                                        <label class="cursor-pointer bg-gray-800 hover:bg-gray-700 text-white p-3 rounded-lg border border-gray-700">
                                            <i data-lucide="upload" class="w-5 h-5"></i>
                                            <input type="file" class="hidden" accept="image/*" onchange="window.posApp.handleImageUpload(this)">
                                        </label>
                                    </div>
                                    <p class="text-xs text-gray-500 mt-1 italic">Pega una URL o sube una imagen.</p>
                                </div>

                                <div class="flex justify-between items-center mt-8 pt-6 border-t border-gray-800">
                                    <button type="button" onclick="document.getElementById('editor-modal').remove()" class="px-4 py-2 text-gray-400 hover:text-white font-bold transition-colors">Cancelar</button>
                                    <button type="submit" class="px-6 py-2 bg-orange-600 hover:bg-orange-500 text-white rounded-xl font-bold shadow-lg shadow-orange-900/20 transition-all">Guardar</button>
                                </div>

                                ${isManager && isEdit ? `
                                <div class="border-t border-gray-800 pt-6 mt-6">
                                    <h3 class="text-white font-bold mb-4 flex items-center gap-2">
                                        <i data-lucide="chef-hat" class="w-4 h-4 text-orange-500"></i> Ingredientes de Receta
                                    </h3>
                                    
                                    <div class="space-y-3 mb-4 max-h-40 overflow-y-auto custom-scrollbar" id="recipe-list">
                                         ${(p.recipe || []).map(ing => {
                    const invItem = store.state.inventory.find(i => i.id === ing.id);
                    return `
                                                <div class="flex gap-2 items-center bg-gray-800/50 p-2 rounded-xl border border-gray-700/50">
                                                    <div class="flex-1 min-w-0">
                                                        <span class="text-gray-300 text-sm font-bold block truncate">${invItem ? invItem.name : ing.id}</span>
                                                        <span class="text-gray-500 text-[10px]">Id: ${ing.id}</span>
                                                    </div>
                                                    <input type="number" step="0.001" name="recipe_qty_${ing.id}" value="${ing.qty}" class="w-20 bg-gray-900 border border-gray-700 rounded-lg p-1.5 text-white text-sm focus:border-orange-500 outline-none text-right font-mono">
                                                    <span class="text-gray-500 text-[10px] w-8">${invItem ? invItem.unit : ''}</span>
                                                    <input type="hidden" name="recipe_id[]" value="${ing.id}">
                                                    <button type="button" onclick="this.closest('.flex').remove()" class="text-red-500 hover:bg-red-500/10 p-2 rounded-lg transition-colors"><i data-lucide="trash" class="w-4 h-4"></i></button>
                                                </div>
                                             `;
                }).join('')}
                                    </div>

                                    <div class="flex gap-2 bg-gray-900 p-2 rounded-xl border border-gray-800">
                                        <select id="new-ing-select" class="flex-1 bg-gray-900 border-none p-2 text-white text-sm focus:ring-0 outline-none cursor-pointer appearance-none">
                                            <option value="" disabled selected class="bg-gray-900 text-gray-400"> + Seleccionar Ingrediente</option>
                                            ${store.state.inventory.map(i => `<option value="${i.id}" class="bg-gray-900 text-white">${i.name} (${i.unit})</option>`).join('')}
                                        </select>
                                        <button type="button" onclick="window.posApp.addIngredientRow()" class="bg-orange-600 hover:bg-orange-500 text-white w-10 h-10 rounded-lg font-bold transition-all flex items-center justify-center">
                                            <i data-lucide="plus" class="w-4 h-4"></i>
                                        </button>
                                    </div>
                                </div>
                                ` : ''}
                            </form>
                        </div>
                    </div>
                `;
            },

            renderSaleDetailsModal(sale) {
                return `
                    <div class="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4" id="sale-modal">
                        <div class="glass-panel w-full max-w-md rounded-3xl p-6 shadow-2xl animate-in zoom-in-95 relative overflow-hidden">
                            <button onclick="document.getElementById('sale-modal').remove()" class="absolute top-4 right-4 p-2 hover:bg-gray-800 rounded-xl text-gray-400 hover:text-white transition-all z-10">
                                <i data-lucide="x" class="w-6 h-6"></i>
                            </button>

                            <div class="text-center mb-8">
                                <div class="w-16 h-16 bg-orange-600/10 text-orange-500 rounded-3xl flex items-center justify-center mx-auto mb-4 border border-orange-500/10 shadow-inner">
                                    <i data-lucide="receipt" class="w-8 h-8"></i>
                                </div>
                                <h2 class="text-2xl font-bold text-white mb-1">Ticket #${sale.ticketNumber || sale.id.toString().slice(-6)}</h2>
                                <p class="text-gray-500 text-xs font-bold uppercase tracking-widest">${new Date(sale.date).toLocaleString([], { dateStyle: 'medium', timeStyle: 'short' })}</p>
                                <p class="text-gray-500 text-[10px] mt-2 italic">Atendido por: ${sale.employee}</p>
                            </div>

                            <div class="space-y-3 mb-8 max-h-[40vh] overflow-y-auto pr-2 custom-scrollbar">
                                ${sale.items.map(item => `
                                    <div class="flex justify-between items-center p-4 bg-gray-900/50 rounded-2xl border border-gray-800">
                                        <div class="flex items-center gap-4">
                                            <div class="w-10 h-10 rounded-xl bg-gray-800 flex items-center justify-center text-sm font-bold text-orange-500 border border-gray-700 shadow-lg">
                                                ${item.qty || 1}x
                                            </div>
                                            <div>
                                                <p class="text-white font-bold text-sm">${item.product ? item.product.name : (item.name || 'Desconocido')}</p>
                                                <p class="text-gray-600 text-[10px] font-mono">$${(item.product ? item.product.price : (item.price || 0)).toFixed(2)} c/u</p>
                                            </div>
                                        </div>
                                        <p class="text-white font-bold">$${((item.product ? item.product.price : (item.price || 0)) * (item.qty || 1)).toFixed(2)}</p>
                                    </div>
                                `).join('')}
                            </div>

                            <div class="flex justify-between items-end pt-6 border-t border-gray-800/50 mt-4 px-2">
                                <span class="text-gray-500 text-xs font-bold uppercase tracking-widest">Total Cancelado</span>
                                <span class="text-3xl font-bold text-orange-500">$${(sale.total || 0).toFixed(2)}</span>
                            </div>

                            <div class="mt-8 space-y-3">
                                <p class="text-[10px] text-gray-500 uppercase font-black tracking-[0.2em] text-center border-b border-gray-800 pb-2">Gestión de Estatus</p>
                                <div class="grid grid-cols-3 gap-2">
                                    <button onclick="window.posApp.updateOrderStatus('${sale.id}', 'Abierta')"
                                        ${sale.status !== 'Abierta' ? 'disabled' : ''}
                                        class="py-3 rounded-xl text-[10px] font-black tracking-tighter border transition-all ${sale.status === 'Abierta' ? 'bg-orange-600 text-white border-orange-500 shadow-lg shadow-orange-900/30' : 'bg-gray-900 text-gray-600 border-gray-800 opacity-50 cursor-not-allowed'}">
                                        ABIERTA
                                    </button>
                                    <button onclick="window.posApp.updateOrderStatus('${sale.id}', 'En Proceso')"
                                        ${(sale.status === 'Entregada' || sale.status === 'En Proceso') ? 'disabled' : ''}
                                        class="py-3 rounded-xl text-[10px] font-black tracking-tighter border transition-all ${sale.status === 'En Proceso' ? 'bg-blue-600 text-white border-blue-500 shadow-lg shadow-blue-900/30' : 'bg-gray-900 text-gray-600 border-gray-800 opacity-50 cursor-not-allowed'}">
                                        PROCESO
                                    </button>
                                    <button onclick="window.posApp.updateOrderStatus('${sale.id}', 'Entregada')"
                                        ${sale.status === 'Entregada' ? 'disabled' : ''}
                                        class="py-3 rounded-xl text-[10px] font-black tracking-tighter border transition-all ${sale.status === 'Entregada' ? 'bg-green-600 text-white border-green-500 shadow-lg shadow-green-900/30' : 'bg-gray-900 text-gray-600 border-gray-800 opacity-50 cursor-not-allowed'}">
                                        ENTREGA
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            },

            renderPinModal(targetPin, userName) {
                return `
                    <div class="fixed inset-0 z-[60] flex items-center justify-center bg-black/95 backdrop-blur-xl p-4" id="pin-modal">
                        <div class="w-full max-w-xs animate-in fade-in zoom-in-95 duration-300">
                            <div class="text-center mb-8">
                                <div class="w-16 h-16 bg-orange-600/20 text-orange-500 rounded-3xl flex items-center justify-center mx-auto mb-4 border border-orange-500/20">
                                    <i data-lucide="lock" class="w-8 h-8"></i>
                                </div>
                                <h2 class="text-2xl font-bold text-white mb-1">Confirmar Acceso</h2>
                                <p class="text-gray-500 text-sm">Hola, <span class="text-orange-500 font-bold">${userName}</span></p>
                            </div>
                            
                            <div class="flex flex-col gap-6">
                                <input type="password" id="pin-input" maxlength="4" placeholder="••••" autofocus
                                    class="w-full bg-gray-900 border-2 border-gray-800 rounded-2xl p-6 text-center text-4xl tracking-[1em] text-white focus:border-orange-600 outline-none shadow-2xl transition-all">
                                
                                <div class="grid grid-cols-3 gap-3">
                                    ${[1, 2, 3, 4, 5, 6, 7, 8, 9].map(n => `
                                        <button onclick="document.getElementById('pin-input').value += '${n}'" class="aspect-square bg-gray-900/50 hover:bg-orange-600/20 border border-gray-800 rounded-2xl flex items-center justify-center text-2xl font-bold text-white transition-all active:scale-90">${n}</button>
                                    `).join('')}
                                    <button onclick="document.getElementById('pin-input').value = ''" class="aspect-square bg-red-600/10 hover:bg-red-600/20 border border-red-500/20 rounded-2xl flex items-center justify-center text-red-500 font-bold active:scale-90"><i data-lucide="delete" class="w-6 h-6"></i></button>
                                    <button onclick="document.getElementById('pin-input').value += '0'" class="aspect-square bg-gray-900/50 hover:bg-orange-600/20 border border-gray-800 rounded-2xl flex items-center justify-center text-2xl font-bold text-white transition-all active:scale-90">0</button>
                                    <button onclick="window.posApp.validatePin('${targetPin}')" class="aspect-square bg-orange-600 hover:bg-orange-500 rounded-2xl flex items-center justify-center text-white active:scale-90 shadow-lg shadow-orange-900/20"><i data-lucide="check" class="w-8 h-8"></i></button>
                                </div>
                                
                                <button onclick="document.getElementById('pin-modal').remove()" class="text-gray-500 hover:text-white font-bold py-2 transition-colors">Cancelar</button>
                            </div>
                        </div>
                    </div>
                `;
            },

            renderProductModal(productId) {
                const store = window.store; // Safely get store
                const product = store.state.products.find(p => p.id === productId);
                if (!product) return '';

                return `
                    <div class="fixed inset-0 z-50 flex items-end sm:items-center justify-center bg-black/80 backdrop-blur-sm p-4" id="prod-modal">
                        <div class="glass-panel w-full max-w-md rounded-t-[2.5rem] sm:rounded-3xl p-6 shadow-2xl animate-in slide-in-from-bottom sm:zoom-in-95 relative overflow-hidden">
                            <div class="absolute inset-0 bg-gradient-to-b from-orange-600/5 to-transparent pointer-events-none"></div>
                            
                            <button onclick="document.getElementById('prod-modal').remove()" class="absolute top-4 right-4 p-2 hover:bg-gray-800 rounded-xl text-gray-400 hover:text-white transition-all z-10">
                                <i data-lucide="x" class="w-6 h-6"></i>
                            </button>

                            <div class="relative h-64 -mx-6 -mt-6 mb-6 group overflow-hidden">
                                <img src="${product.image}" class="w-full h-full object-cover">
                                <div class="absolute inset-0 bg-gradient-to-t from-gray-950 via-gray-950/20 to-transparent"></div>
                                <div class="absolute bottom-4 left-6">
                                    <span class="px-3 py-1 bg-orange-600 text-white text-[10px] font-black uppercase tracking-widest rounded-lg shadow-lg mb-2 inline-block">${product.category}</span>
                                    <h2 class="text-3xl font-black text-white drop-shadow-lg">${product.name}</h2>
                                </div>
                            </div>

                            <div class="flex flex-col gap-6">
                                <div class="flex justify-between items-center bg-gray-900/50 p-4 rounded-2xl border border-gray-800">
                                    <span class="text-gray-500 font-bold uppercase tracking-widest text-xs">Precio Unitario</span>
                                    <span class="text-3xl font-black text-orange-500">$${product.price}</span>
                                </div>

                                 <div class="space-y-4">
                                    <p class="text-xs text-gray-500 uppercase font-bold tracking-widest px-1">Cantidad</p>
                                    <div class="flex items-center justify-between bg-gray-900 p-2 rounded-3xl border border-gray-800">
                                        <button onclick="const q = document.getElementById('qty'); q.value = Math.max(1, parseInt(q.value)-1)" class="w-14 h-14 rounded-2xl bg-gray-800 text-white hover:bg-gray-700 active:scale-95 transition-all flex items-center justify-center"><i data-lucide="minus" class="w-6 h-6"></i></button>
                                        <input type="number" id="qty" value="1" min="1" class="w-20 bg-transparent text-center text-3xl font-bold text-white outline-none">
                                        <button onclick="const q = document.getElementById('qty'); q.value = parseInt(q.value)+1" class="w-14 h-14 rounded-2xl bg-orange-600 text-white hover:bg-orange-500 active:scale-95 transition-all flex items-center justify-center"><i data-lucide="plus" class="w-6 h-6"></i></button>
                                    </div>
                                </div>

                                <div class="space-y-2">
                                    <p class="text-xs text-gray-500 uppercase font-bold tracking-widest px-1">Notas especiales</p>
                                    <textarea id="modal-notes" placeholder="Ej: Sin cebolla, extra salsa..."
                                        class="w-full bg-gray-900 border border-gray-800 rounded-2xl p-4 text-white text-sm focus:border-orange-500 outline-none resize-none h-24 placeholder:text-gray-600 transition-all"></textarea>
                                </div>

                                <button onclick="window.posApp.addToCartFromModal('${product.id}')" 
                                    class="w-full bg-orange-600 hover:bg-orange-500 text-white p-5 rounded-2xl font-black text-lg shadow-xl shadow-orange-900/30 active:scale-[0.98] transition-all flex items-center justify-center gap-3 mt-2">
                                    <i data-lucide="shopping-cart" class="w-6 h-6"></i> AGREGAR A LA ORDEN
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            },

            renderAdjustmentModal(itemId) {
                const store = window.store;
                const item = store.state.inventory.find(i => i.id === itemId);
                if (!item) return '';

                return `
                    <div class="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4" id="adj-modal">
                        <div class="glass-panel w-full max-w-sm rounded-3xl p-8 shadow-2xl animate-in zoom-in-95 border-t-4 border-orange-500">
                            <h2 class="text-2xl font-black text-white mb-2 uppercase tracking-tight">AJUSTE MANUAL</h2>
                            <p class="text-gray-500 text-xs mb-8">Corregir cantidad exacta de <span class="text-white font-bold">${item.name}</span></p>
                            
                            <form onsubmit="window.posApp.handleAdjustInventory(event, '${itemId}')" class="space-y-6">
                                <div class="bg-gray-950 p-4 rounded-2xl border border-gray-800">
                                    <label class="block text-[10px] text-gray-500 font-black uppercase tracking-widest mb-2">Cantidad en Inventario (${item.unit})</label>
                                    <input type="number" name="quantity" step="0.001" value="${item.quantity}" required autofocus
                                        class="w-full bg-transparent text-4xl font-mono font-bold text-orange-500 outline-none">
                                </div>
                                
                                <div>
                                    <label class="block text-sm text-gray-300 mb-1 font-medium">Motivo del Ajuste (Obligatorio)</label>
                                    <textarea name="note" required rows="3" placeholder="Ej: Error en conteo, Desperdicio, Merma..." class="w-full bg-gray-900 border border-gray-700 rounded-lg p-3 text-white focus:border-orange-500 outline-none placeholder:text-gray-600"></textarea>
                                </div>

                                <div class="flex gap-4 pt-2">
                                    <button type="button" onclick="document.getElementById('adj-modal').remove()" class="flex-1 px-4 py-4 text-gray-500 hover:text-white font-bold transition-all">Cancelar</button>
                                    <button type="submit" class="flex-[2] bg-orange-600 hover:bg-orange-500 text-white py-4 rounded-2xl font-black shadow-lg shadow-orange-900/20 transition-all">GUARDAR CAMBIO</button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;
            },

            renderRestockModal(itemId) {
                const store = window.store;
                const item = store.state.inventory.find(i => i.id === itemId);
                if (!item) return '';

                return `
                    <div class="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4" id="res-modal">
                        <div class="glass-panel w-full max-w-sm rounded-3xl p-8 shadow-2xl animate-in zoom-in-95 border-t-4 border-green-500">
                            <h2 class="text-2xl font-black text-white mb-2 uppercase tracking-tight">REPONER STOCK</h2>
                            <p class="text-gray-500 text-xs mb-8">Sumar nueva mercancía al inventario de <span class="text-white font-bold">${item.name}</span></p>
                            
                            <form onsubmit="window.posApp.handleRestockInventory(event, '${itemId}')" class="space-y-6">
                                <div class="bg-gray-950 p-4 rounded-2xl border border-gray-800">
                                    <label class="block text-[10px] text-gray-500 font-black uppercase tracking-widest mb-2">Cantidad a Sumar (${item.unit})</label>
                                    <input type="number" name="amount" step="0.001" placeholder="0.000" required autofocus
                                        class="w-full bg-transparent text-4xl font-mono font-bold text-green-500 outline-none">
                                </div>
                                
                                <div class="flex gap-4 pt-2">
                                    <button type="button" onclick="document.getElementById('res-modal').remove()" class="flex-1 px-4 py-4 text-gray-500 hover:text-white font-bold transition-all">Cancelar</button>
                                    <button type="submit" class="flex-[2] bg-green-600 hover:bg-green-500 text-white py-4 rounded-2xl font-black shadow-lg shadow-green-900/20 transition-all">CONFIRMAR INGRESO</button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;
            }
        };
    </script>

    <!-- 3. APP CONTROLLER -->
    <script>
        const appDiv = document.getElementById('app');
        const store = window.store; // Ensure store is accessible
        const views = window.views; // Ensure views is accessible

        // Setup Global Namespace
        window.posApp = {
            activeView: 'pos',
            activeCategory: 'all',
            posMobileView: 'menu',
            adminTab: 'dashboard',
            currentPinInput: '',

            init: function () {
                store.subscribe((currentStore) => {
                    render(currentStore);
                });
                store.fetchBCVRate();
                setInterval(() => store.fetchBCVRate(), 10 * 60 * 1000);
                store.updateDocumentTitle();
            },

            login: function (pin) { return store.login(pin); },
            logout: function () { return store.logout(); },
            addToCart: function (product) { return store.addToCart(product); },
            removeFromCart: function (id) { return store.decreaseCartItem(id); },
            clearCart: function () { return store.clearCart(); },
            checkout: handleCheckout,
            openProductModal: openProductModal,
            closeModal: closeProductModal,
            addToCartFromModal: addToCartFromModal,
            setView: setView,
            setAdminTab: setAdminTab,
            filterCategory: function (catId) {
                this.activeCategory = catId;
                store.notify();
            },

            // PIN Logic
            requestPin: requestPin,
            enterPinDigit: enterPinDigit,
            backspacePin: backspacePin,
            validatePin: validatePin,

            // Config
            handleUpdateSettings: function (event) {
                event.preventDefault();
                const formData = new FormData(event.target);
                const newSettings = {
                    storeName: formData.get('storeName'),
                    storeSubtitle: formData.get('storeSubtitle'),
                    receiptHeader: formData.get('receiptHeader'),
                    receiptFooter: formData.get('receiptFooter')
                };
                store.updateSettings(newSettings);
                alert('Configuración guardada correctamente.');
            },

            // BCV Rate
            setManualRate: function () {
                const current = store.state.bcvRate ? store.state.bcvRate.rate : 0;
                const newRate = prompt("Ingresar Tasa BCV Manual (Dólar):", current > 0 ? current : "40");
                if (newRate !== null) {
                    const parsed = parseFloat(newRate.replace(',', '.'));
                    if (!isNaN(parsed) && parsed > 0) {
                        store.updateRate(parsed, true);
                    } else {
                        alert("Por favor ingrese un número válido.");
                    }
                }
            },

            // Sale & Order Management
            openSaleDetails: function (id) {
                const sale = store.state.sales.find(s => s.id == id);
                if (sale) {
                    const modal = views.renderSaleDetailsModal(sale);
                    document.getElementById('modal-container').innerHTML = modal;
                    requestAnimationFrame(() => window.lucide.createIcons());
                }
            },

            updateOrderStatus: function (saleId, newStatus) {
                if (store.updateSaleStatus(saleId, newStatus)) {
                    const sale = store.state.sales.find(s => s.id == saleId);
                    if (sale) {
                        const modal = views.renderSaleDetailsModal(sale);
                        document.getElementById('modal-container').innerHTML = modal;
                        requestAnimationFrame(() => window.lucide.createIcons());
                    }
                }
            },

            // Product & Category Management
            openProductEditor: openProductEditor,
            handleImageUpload: handleImageUpload,
            saveProduct: saveProduct,
            deleteProduct: handleDeleteProduct,
            addIngredientRow: addIngredientRow,
            handleAddCategory: handleAddCategory,
            handleDeleteCategory: handleDeleteCategory,

            // Inventory
            handleAddInventoryItem: handleAddInventoryItem,
            handleDeleteInventoryItem: handleDeleteInventoryItem,
            openAdjustmentModal: openAdjustmentModal,
            handleAdjustInventory: handleAdjustInventory,
            openRestockModal: openRestockModal,
            handleRestockInventory: handleRestockInventory,

            // User Management
            handleUpdatePin: function (userId) {
                const newPin = prompt("Ingrese el nuevo PIN de 4 dígitos:");
                if (newPin) {
                    if (newPin.length !== 4 || isNaN(newPin)) {
                        alert("El PIN debe ser de exactamente 4 números.");
                        return;
                    }
                    if (store.updateUserPin(userId, newPin)) {
                        alert("PIN actualizado correctamente.");
                    }
                }
            },

            // Session & Reporting
            handleCloseSession: function () {
                if (confirm('¿Confirmar CIERRE DE VENTAS? Se eliminarán todas las ventas de la sesión actual.')) {
                    store.closeSession();
                    alert('Jornada cerrada correctamente.');
                }
            },

            handlePrintSessionReport: function () {
                const sales = store.state.sales;
                const total = sales.reduce((sum, s) => sum + (s.total || 0), 0);
                const date = new Date().toLocaleString();

                const printContent = `
    <html>
        <head>
            <title>Reporte de Jornada - ${date}</title>
            <style>
                body { font-family: monospace; padding: 20px; }
                h1 { text-align: center; border-bottom: 2px solid #000; padding-bottom: 10px; }
                .summary { margin-bottom: 20px; font-weight: bold; }
                table { border-collapse: collapse; margin-top: 20px; width: 100%; }
                th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                th { background-color: #f2f2f2; }
                .text-right { text-align: right; }
                .grand-total { text-align: right; font-size: 1.5em; font-weight: bold; margin-top: 20px; }
            </style>
        </head>
        <body>
            <h1>Reporte de Cierre de Jornada</h1>
            <div class="summary">
                <p>Fecha: ${date}</p>
                <p>Total Transacciones: ${sales.length}</p>
                <p>Generado por: ${store.currentUser.name}</p>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Ticket</th>
                        <th>Hora</th>
                        <th>Empleado</th>
                        <th>Monto</th>
                    </tr>
                </thead>
                <tbody>
                    ${sales.map(s => `
                    <tr>
                        <td>#${s.ticketNumber || s.id.toString().slice(-6)}</td>
                        <td>${new Date(s.date).toLocaleTimeString()}</td>
                        <td>${s.employee}</td>
                        <td class="text-right">$${(s.total || 0).toFixed(2)}</td>
                    </tr>
                    `).join('')}
                </tbody>
            </table>
            <div class="grand-total">Total Venta: $${total.toFixed(2)}</div>
        </body>
    </html>`;

                const printWindow = window.open('', '', 'width=800,height=600');
                printWindow.document.write(printContent);
                printWindow.document.close();
                printWindow.focus();
                setTimeout(() => {
                    printWindow.print();
                    printWindow.close();
                }, 250);
            },

            toggleMobilePOS: function () {
                this.posMobileView = this.posMobileView === 'menu' ? 'cart' : 'menu';
                store.notify();
            }
        };

        function setView(viewName) {
            window.posApp.activeView = viewName;
            store.notify();
        }

        function render(s) {
            const activeView = window.posApp.activeView;

            requestAnimationFrame(() => {
                if (window.lucide) window.lucide.createIcons();
            });

            if (!s.currentUser) {
                appDiv.innerHTML = views.renderLogin();
                return;
            }

            appDiv.innerHTML = `
<div class="flex flex-col md:flex-row h-full w-full bg-gray-950 text-white overflow-hidden">
    <aside class="hidden md:flex w-20 flex-col items-center py-6 bg-gray-900 border-r border-gray-800 z-30 shadow-xl">
        <div class="mb-4 p-2 bg-gradient-to-br from-orange-500 to-orange-700 rounded-xl shadow-lg shadow-orange-900/50">
            <i data-lucide="flame" class="w-8 h-8 text-white"></i>
        </div>

        <div class="mb-4 flex flex-col items-center text-center px-1">
            <div class="flex items-center gap-1 mb-1">
                <span class="text-[10px] text-gray-500 font-bold uppercase tracking-wider">BCV</span>
                <button onclick="window.store.fetchBCVRate()" class="text-gray-600 hover:text-white transition-colors"
                    title="Actualizar Tasa">
                    <i data-lucide="refresh-cw" class="w-3 h-3"></i>
                </button>
            </div>
            <button onclick="window.posApp.setManualRate()"
                class="block cursor-pointer hover:scale-105 transition-transform" title="Click para ajustar manual">
                <div
                    class="text-xs font-bold ${s.bcvRate && s.bcvRate.rate > 0 ? (s.bcvRate.isManual ? 'text-orange-400' : 'text-green-500') : 'text-red-500'} font-mono">
                    ${s.bcvRate && s.bcvRate.rate > 0 ? 'Bs.' + s.bcvRate.rate.toFixed(2) : (s.bcvRate && s.bcvRate.rate
                    === -1 ? 'Err API' : 'Cargando...')}
                </div>
                ${s.bcvRate && s.bcvRate.isManual ? '<span class="text-[8px] text-orange-500/70 block uppercase">Manual</span>' : ''}
            </button>
        </div>

        <nav class="flex-1 flex flex-col gap-6 w-full items-center">
            <button onclick="window.posApp.setView('pos')"
                class="p-3 rounded-2xl transition-all duration-300 group ${activeView === 'pos' ? 'bg-orange-600 text-white shadow-lg shadow-orange-900/40 translate-x-1' : 'hover:bg-gray-800 text-gray-500 hover:text-gray-300'}">
                <i data-lucide="layout-grid" class="w-6 h-6"></i>
            </button>
            <button onclick="window.posApp.setView('admin')"
                class="p-3 rounded-2xl transition-all duration-300 group ${activeView === 'admin' ? 'bg-orange-600 text-white shadow-lg shadow-orange-900/40 translate-x-1' : 'hover:bg-gray-800 text-gray-500 hover:text-gray-300'}">
                <i data-lucide="package" class="w-6 h-6"></i>
            </button>
        </nav>

        <div class="flex flex-col gap-4 items-center mb-4">
            <div class="w-10 h-10 rounded-full bg-gray-800 border border-gray-700 flex items-center justify-center text-sm font-bold text-gray-300"
                title="${s.currentUser.name}">
                ${s.currentUser.name.charAt(0)}
            </div>
            <button onclick="window.posApp.logout()"
                class="p-3 rounded-2xl hover:bg-red-500/10 text-gray-600 hover:text-red-500 transition-colors">
                <i data-lucide="log-out" class="w-6 h-6"></i>
            </button>
        </div>
    </aside>

    <nav
        class="md:hidden fixed bottom-0 left-0 right-0 h-16 bg-gray-900 border-t border-gray-800 flex justify-around items-center z-50 px-4 pb-safe shadow-2xl">
        <button onclick="window.posApp.setView('pos')"
            class="flex flex-col items-center gap-1 ${activeView === 'pos' ? 'text-orange-500' : 'text-gray-500'}">
            <i data-lucide="layout-grid" class="w-5 h-5"></i>
            <span class="text-[10px] font-bold uppercase">Tienda</span>
        </button>
        <button onclick="window.posApp.setView('admin')"
            class="flex flex-col items-center gap-1 ${activeView === 'admin' ? 'text-orange-500' : 'text-gray-500'}">
            <i data-lucide="package" class="w-5 h-5"></i>
            <span class="text-[10px] font-bold uppercase">Admin</span>
        </button>
        <div class="relative -top-3">
            <button onclick="window.posApp.setManualRate()"
                class="w-12 h-12 bg-gray-800 border border-gray-700 rounded-full flex flex-col items-center justify-center shadow-lg active:scale-95 transition-transform">
                <span class="text-[8px] text-gray-500 font-bold">BCV</span>
                <span class="text-[10px] font-bold text-green-500">${s.bcvRate && s.bcvRate.rate > 0 ?
                    s.bcvRate.rate.toFixed(1) : (s.bcvRate && s.bcvRate.rate === -1 ? 'Err' : '...')}</span>
            </button>
        </div>
        <button onclick="window.posApp.logout()"
            class="flex flex-col items-center gap-1 text-gray-500 hover:text-red-500">
            <i data-lucide="log-out" class="w-5 h-5"></i>
            <span class="text-[10px] font-bold uppercase">Salir</span>
        </button>
    </nav>

                    <main id="main-content" class="flex-1 flex overflow-hidden relative bg-black/20 pb-16 md:pb-0">
                        ${activeView === 'pos' ? views.renderPOS() : views.renderAdmin()}
                    </main>
                </div>
            `;
        }

        // --- Event Handlers & Logic ---

        function setView(viewName) {
            window.posApp.activeView = viewName;
            store.notify();
        }

        function setAdminTab(tab) {
            window.posApp.adminTab = tab;
            store.notify();
        }

        // PIN Logic
        function requestPin(correctPin, userName) {
            window.posApp.currentPinInput = '';
            const modal = views.renderPinModal(correctPin, userName);
            document.getElementById('modal-container').innerHTML = modal;
            requestAnimationFrame(() => window.lucide.createIcons());
        }

        function validatePin(correctPin) {
            const input = document.getElementById('pin-input');
            const pin = input.value;
            if (pin === correctPin) {
                store.login(pin);
                document.getElementById('pin-modal').remove();
            } else {
                alert('PIN Incorrecto');
                input.value = '';
                window.posApp.currentPinInput = '';
                updatePinDots();
            }
        }

        function enterPinDigit(digit, correctPin) {
            window.posApp.currentPinInput += digit;
            updatePinDots();

            const input = document.getElementById('pin-input');
            if (input) input.value = window.posApp.currentPinInput;

            if (window.posApp.currentPinInput.length === 4) {
                setTimeout(() => {
                    validatePin(correctPin);
                }, 300);
            }
        }

        function backspacePin() {
            window.posApp.currentPinInput = window.posApp.currentPinInput.slice(0, -1);
            updatePinDots();
            const input = document.getElementById('pin-input');
            if (input) input.value = window.posApp.currentPinInput;
        }

        function updatePinDots() {
            const len = window.posApp.currentPinInput.length;
            for (let i = 1; i <= 4; i++) {
                const dot = document.getElementById(`pin-dot-${i}`);
                if (dot) {
                    dot.classList.toggle('bg-orange-500', i <= len);
                    dot.classList.toggle('bg-gray-700', i > len);
                }
            }
        }

        // Product Manager Logic
        function openProductEditor(productId = null) {
            const product = productId ? store.state.products.find(p => p.id === productId) : null;
            const modal = views.renderProductEditorModal(product);
            document.getElementById('modal-container').innerHTML = modal;
            requestAnimationFrame(() => window.lucide.createIcons());
        }

        function handleImageUpload(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    document.getElementById('img-url-input').value = e.target.result;
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function saveProduct(event, id) {
            event.preventDefault();
            const formData = new FormData(event.target);

            const recipe = [];
            const recipeIds = formData.getAll('recipe_id[]');
            recipeIds.forEach(rId => {
                const qty = formData.get(`recipe_qty_${rId} `);
                if (qty) {
                    recipe.push({ id: rId, qty: parseFloat(qty) });
                }
            });

            const product = {
                id: id && id !== 'undefined' ? id : 'p_' + Date.now(),
                name: formData.get('name'),
                price: parseFloat(formData.get('price')),
                category: formData.get('category'),
                image: formData.get('image') || 'https://via.placeholder.com/150',
                recipe: recipe
            };

            if (id && id !== 'undefined') {
                store.updateProduct(product);
            } else {
                store.addProduct(product);
            }

            document.getElementById('editor-modal').remove();
            // alert('Producto guardado');
        }

        function handleDeleteProduct(id) {
            if (confirm('¿Está seguro de eliminar este producto?\nEsta acción no se puede deshacer.')) {
                store.deleteProduct(id);
                const modal = document.getElementById('editor-modal');
                if (modal) modal.remove();
                store.notify();
            }
        }

        // Inventory Logic
        function handleAddInventoryItem() {
            const name = prompt('Nombre del nuevo ingrediente:');
            if (!name) return;

            const unit = prompt('Unidad de medida (ej: kg, L, unidad):', 'unidad');
            if (!unit) return;

            const quantity = parseFloat(prompt('Cantidad inicial:', '0'));
            if (isNaN(quantity)) return;

            const alertVal = parseFloat(prompt('Alerta de stock bajo (cantidad):', '10'));
            if (isNaN(alertVal)) return;

            const id = 'inv_' + Date.now();
            store.addInventoryItem({ id, name, unit, quantity, alert: alertVal });
        }

        function handleDeleteInventoryItem(id) {
            if (confirm('¿Eliminar este ingrediente del inventario?')) {
                store.deleteInventoryItem(id);
            }
        }

        // Category Logic
        function handleAddCategory() {
            const name = prompt('Nombre de la nueva categoría:');
            if (name) {
                const id = name.toLowerCase().replace(/[^a-z0-9]/g, '_');

                // Safety check
                if (!store.state.categories) {
                    store.state.categories = [];
                }

                if (store.state.categories.find(c => c.id === id)) {
                    alert('Ya existe una categoría con ese identificador.');
                    return;
                }
                store.addCategory({ id, name });
            }
        }

        function handleDeleteCategory(id) {
            if (confirm('¿Eliminar categoría?')) {
                store.deleteCategory(id);
            }
        }

        function addIngredientRow() {
            const select = document.getElementById('new-ing-select');
            const ingId = select.value;
            if (!ingId) return;

            const ingText = select.options[select.selectedIndex].text;
            const existing = document.querySelector(`input[name = "recipe_id[]"][value = "${ingId}"]`);
            if (existing) {
                alert('Este ingrediente ya está en la lista');
                return;
            }

            const div = document.createElement('div');
            div.className = 'flex gap-2 items-center bg-gray-800/50 p-2 rounded-xl border border-gray-700/50 animate-in fade-in slide-in-from-bottom-2';
            div.innerHTML = `
                <div class="flex-1 min-w-0">
                    <span class="text-gray-300 text-sm font-bold block truncate">${ingText}</span>
                </div>
                <input type="number" step="0.001" name="recipe_qty_${ingId}" value="1"
                    class="w-20 bg-gray-900 border border-gray-700 rounded-lg p-1.5 text-white text-sm focus:border-orange-500 outline-none text-right font-mono">
                <input type="hidden" name="recipe_id[]" value="${ingId}">
                <button type="button" onclick="this.closest('.flex').remove()"
                    class="text-red-500 hover:bg-red-500/10 p-2 rounded-lg transition-colors">
                    <i data-lucide="trash" class="w-4 h-4"></i>
                </button>
            `;
            document.getElementById('recipe-list').appendChild(div);
            requestAnimationFrame(() => window.lucide.createIcons());
            select.value = "";
        }

        function openProductModal(productId) {
            const modalHtml = views.renderProductModal(productId);
            document.getElementById('modal-container').innerHTML = modalHtml;
            requestAnimationFrame(() => window.lucide.createIcons());
        }

        function closeProductModal() {
            document.getElementById('modal-container').innerHTML = '';
        }

        function addToCartFromModal(productId) {
            const notes = document.getElementById('modal-notes').value || '';
            const qty = parseInt(document.getElementById('qty').value) || 1;
            const product = store.state.products.find(p => p.id === productId);

            if (store.addToCart(product, notes, qty)) {
                closeProductModal();
            }
        }

        function handleAddStock(ingId) {
            // Deprecated - Replaced by Adjustment Modal but kept for reference
            const qty = prompt("Ingrese cantidad a agregar (número):", "10");
            if (qty && !isNaN(qty)) {
                const current = store.state.inventory.find(i => i.id === ingId);
                if (current) {
                    const newTotal = current.quantity + parseFloat(qty);
                    store.updateInventory(ingId, newTotal);
                }
            }
        }

        function openAdjustmentModal(itemId) {
            const modalHtml = views.renderAdjustmentModal(itemId);
            document.getElementById('modal-container').innerHTML = modalHtml;
            requestAnimationFrame(() => window.lucide.createIcons());
        }

        function handleAdjustInventory(event, itemId) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const newQuantity = parseFloat(formData.get('quantity'));
            const note = formData.get('note');

            if (store.adjustInventory(itemId, newQuantity, note, store.currentUser)) {
                document.getElementById('adj-modal').remove();
            }
        }

        function openRestockModal(itemId) {
            const modalHtml = views.renderRestockModal(itemId);
            document.getElementById('modal-container').innerHTML = modalHtml;
            requestAnimationFrame(() => window.lucide.createIcons());
        }

        function handleRestockInventory(event, itemId) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const amount = parseFloat(formData.get('amount'));

            if (amount > 0) {
                if (store.restockInventory(itemId, amount, store.currentUser)) {
                    document.getElementById('res-modal').remove();
                    alert('Stock agregado correctamente.');
                }
            }
        }

        // Printing Logic
        async function handleCheckout() {
            if (store.cart.length === 0) return;

            // Trigger background rate update (don't await let it happen in background)
            store.fetchBCVRate();

            const rate = store.state.bcvRate ? store.state.bcvRate.rate : 0;
            const rateMsg = rate > 0 ? `\n(Tasa BCV Actual: ${rate.toFixed(2)} Bs)` : '';

            if (confirm(`¿Confirmar venta e imprimir ticket?${rateMsg}`)) {
                const sale = store.checkout();
                if (sale) {
                    printTicket(sale);
                }
            }
        }

        function printTicket(sale) {
            const printArea = document.getElementById('receipt-print-area');
            const date = new Date(sale.date).toLocaleString('es-ES');
            const settings = store.state.settings || {};

            printArea.classList.remove('hidden');
            printArea.style.display = 'block';

            printArea.innerHTML = `
                        <div style="width: 58mm; padding: 10px; font-family: monospace; font-size: 12px; line-height: 1.2;">
                            <div style="text-align: center; margin-bottom: 10px;">
                                <h2 style="margin: 0; font-size: 14px; font-weight: bold; white-space: pre-wrap;">${settings.receiptHeader || 'FLAME & FEAST\nFast Food Premium'}</h2>
                                <p style="margin: 2px 0;">----------------</p>
                            </div>

                            <div style="margin-bottom: 5px;">
                                ORDER: #${sale.ticketNumber || sale.id.toString().slice(-4)}<br>
                                    FECHA: ${date}<br>
                                        CAJERO: ${sale.employee}
                                    </div>

                                    <div style="margin-bottom: 10px; border-bottom: 1px dashed black; padding-bottom: 5px;">
                                        ${sale.items.map(item => `
        <div style="display: flex; justify-content: space-between;">
            <span>${item.qty} x ${item.product.name}</span>
            <span>$${(item.product.price * item.qty).toFixed(2)}</span>
        </div>
        ${item.notes ? `<div style="font-size: 10px; font-style: italic; margin-left: 10px;">(${item.notes})</div>` :
                    ''}
        `).join('')}
                                    </div>

                                    <div style="display: flex; justify-content: space-between; font-weight: bold; font-size: 14px; margin-top: 5px;">
                                        <span>TOTAL:</span>
                                        <span>$${sale.total.toFixed(2)}</span>
                                    </div>

                                    <div style="text-align: center; margin-top: 20px; white-space: pre-wrap;">
                                        ${settings.receiptFooter || '¡Gracias por su compra!\nwww.flameandfeast.com'}
                                    </div>
                            </div>
`;

            setTimeout(() => {
                window.print();
            }, 500);
        }

        // Initialize App
        window.posApp.init();
    </script>
</body>

</html>